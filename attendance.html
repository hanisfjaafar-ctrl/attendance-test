<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Log</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;overflow-x:hidden;}
    
    /* ===== SIDEBAR (35% smaller) ===== */
    .sidebar{width:220px;background:rgba(255,255,255,.95);height:100vh;position:fixed;top:0;left:0;box-shadow:2px 0 12px rgba(0,0,0,.12);transition:all .3s;display:flex;flex-direction:column;backdrop-filter:blur(8px);}
    .sidebar.collapsed{width:55px;}
    .sidebar-header{padding:18px 15px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee;}
    .logo{display:flex;align-items:center;gap:10px;}
    .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:16px;}
    .logo-text{font-size:1.25rem;font-weight:700;color:#333;}
    .sidebar.collapsed .logo-text{display:none;}
    .toggle-btn{background:none;border:none;font-size:1.0rem;cursor:pointer;color:#667eea;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:.3s;}
    .toggle-btn:hover{background:rgba(102,126,234,.1);}
    .nav-links{padding:15px 0;flex:1;}
    .nav-item{padding:9px 20px;display:flex;align-items:center;gap:12px;text-decoration:none;color:#555;font-weight:500;transition:.2s;border-left:3px solid transparent;}
    .nav-item:hover,.nav-item.active{background:rgba(102,126,234,.1);color:#667eea;border-left:3px solid #667eea;}
    .nav-item i{font-size:1.0rem;width:20px;text-align:center;}
    .sidebar.collapsed .nav-item span{display:none;}
    .sidebar.collapsed .nav-item{justify-content:center;padding:12px;gap:0;}
    .user-info{padding:15px;border-top:1px solid #eee;display:flex;align-items:center;gap:12px;}
    .avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:15px;text-transform:uppercase;}
    .user-details{flex:1;}
    .user-name{font-weight:600;color:#333;font-size:0.9rem;}
    .user-email{font-size:.75rem;color:#777;}
    .sidebar.collapsed .user-details{display:none;}

    /* ===== MAIN CONTENT ===== */
    .main-content{flex:1;padding:22px;margin-left:220px;transition:margin-left .3s;}
    .sidebar.collapsed ~ .main-content{margin-left:55px;}
    .container{max-width:1000px;margin:0 auto;background:#fff;padding:28px;border-radius:16px;box-shadow:0 15px 30px rgba(0,0,0,.12);}

    /* ===== HEADER ===== */
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;flex-wrap:wrap;gap:12px;}
    .form-title{color:#333;font-size:1.8rem;font-weight:700;margin:0;}
    .date-controls{display:flex;align-items:center;gap:12px;}
    .date-picker{padding:8px 12px;border:2px solid #e0e0e2;border-radius:8px;font-size:14px;font-weight:600;background:white;color:#333;box-shadow:0 2px 4px rgba(0,0,0,.08);}
    .nav-btn{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;}
    .scan-btn{background:linear-gradient(135deg,#ff6b6b,#ff8e53);color:white;border:none;border-radius:40px;padding:10px 20px;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 3px 10px rgba(255,107,107,.3);}
    .scan-btn:hover{transform:translateY(-2px);}

    /* ===== CHECKOUT BUTTON ===== */
    .checkout-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .checkout-btn:hover { opacity: 0.9; }

    /* ===== TABLE ===== */
    .attendance-table{width:100%;border-collapse:collapse;margin-top:16px;background:white;border-radius:8px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,.08);}
    .attendance-table th{background:linear-gradient(135deg,#667eea,#764ba2);color:white;text-align:left;padding:12px 16px;font-weight:700;font-size:0.95rem;}
    .attendance-table td{padding:12px 16px;border-bottom:1px solid #eee;font-size:0.95rem;}

    /* ===== STATUS BADGES ===== */
    .status.on-time {
      background: rgba(40, 167, 69, 0.15);
      color: #28a745;
      padding: 4px 10px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .status.late {
      background: rgba(255, 77, 7, 0.15);
      color: #b01f06;
      padding: 4px 10px;
      border-radius: 16px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    /* ===== MESSAGES & CONTAINERS ===== */
    .message{padding:12px;border-radius:8px;margin:16px 0;display:none;font-size:0.9rem;}
    .message.success{background:rgba(40,167,69,.15);color:#28a745;border:1px solid #28a745;}
    .message.error{background:rgba(220,53,69,.15);color:#dc3545;border:1px solid #dc3545;}
    .current-date-display{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:6px 12px;border-radius:8px;font-weight:600;font-size:0.9rem;}
    
    .camera-container{display:none;text-align:center;margin-top:16px;padding:16px;background:rgba(255,255,255,.85);border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.1);}
    #videoFeed{border-radius:8px;border:2px solid #667eea;max-width:100%;height:auto;background:#000;display:block;margin:0 auto;}
    .capture-btn{margin-top:12px;}

    #locationMap { height: 240px; border-radius:8px; margin-top:16px; display:none; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    #locationInfo, #locationStatusDisplay { 
      margin-top:10px; 
      padding:10px; 
      background:#f8f9fa; 
      border-radius:8px; 
      display:none; 
      font-size:0.85rem;
    }

    /* ===== WORK MODE ===== */
    .work-mode-selection {
      display:none;
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      margin-top:16px;
      text-align:center;
    }
    .work-mode-title { font-size:1.2rem; margin-bottom:16px; color:#333; }
    .work-mode-options { display:flex; justify-content:center; gap:16px; flex-wrap:wrap; }
    .work-mode-option {
      width:140px;
      padding:16px;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s ease;
      border:2px solid #e0e0e0;
    }
    .work-mode-option:hover { transform:translateY(-4px); box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    .work-mode-option.selected {
      border-color:#667eea;
      background:rgba(102,126,234,0.1);
    }
    .work-mode-icon { font-size:2.0rem; margin-bottom:8px; color:#667eea; }
    .work-mode-label { font-weight:600; font-size:1.0rem; color:#333; }
    .work-mode-desc { font-size:0.8rem; color:#666; margin-top:6px; }

    .radius-info {
      margin-top:12px;
      padding:10px;
      background:#f0f8ff;
      border-radius:8px;
      font-size:0.8rem;
      color:#444;
    }
    .radius-info strong { color:#667eea; }

    .debug-location {
      margin-top:12px;
      padding:10px;
      background:#e8f4ff;
      border-radius:8px;
      font-size:0.8rem;
      color:#2c3e50;
      display:none;
    }

    /* ===== LOADING OVERLAY ===== */
    .loading-overlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background: rgba(102, 126, 234, 0.95);
      display:flex;align-items:center;justify-content:center;flex-direction:column;
      z-index:9999;color:white;display:none;
    }
    .spinner{
      border:3px solid rgba(255,255,255,0.3);
      border-top:3px solid #fff;
      border-radius:50%;
      width:50px;height:50px;
      animation:spin 1s linear infinite;margin-bottom:12px;
    }
    @keyframes spin{0%{transform:rotate(0);}100%{transform:rotate(360deg);}}

    .camera-error {
      color:#dc3545;
      background:rgba(220,53,69,0.1);
      padding:12px;
      border-radius:8px;
      margin:16px 0;
      display:none;
    }

    .location-radius-display {
      display:none;
      margin:16px auto;
      padding:12px;
      border-radius:10px;
      max-width:500px;
      text-align:center;
      font-weight:600;
      box-shadow:0 3px 6px rgba(0,0,0,0.1);
    }
    .location-radius-title { font-size:1.0rem; margin-bottom:8px; }
    .location-radius-status { display:flex; justify-content:center; align-items:center; gap:8px; font-size:0.95rem; }
    .location-radius-dot { width:12px; height:12px; border-radius:50%; }
    .location-radius-green { background-color:#28a745; }
    .location-radius-yellow { background-color:#ffc107; }
    .location-radius-red { background-color:#dc3545; }
    .location-radius-distance { font-weight:bold; margin-left:6px; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .sidebar { width:55px; }
      .sidebar .logo-text,
      .sidebar .user-details,
      .sidebar .nav-item span { display:none; }
      .sidebar .nav-item { justify-content:center; padding:12px; gap:0; }
      .main-content { margin-left:55px; padding:16px; }
      .container { padding:20px; }
      .header { flex-direction:column; align-items:stretch; }
      .date-controls { justify-content:center; }
      .work-mode-options { flex-direction:column; align-items:center; }
      .work-mode-option { width:100%; max-width:220px; }
      #locationMap { height:200px; }
    }
  </style>
</head>
<body>
  <!-- Rest of the HTML and JS remains EXACTLY THE SAME as original -->
  <!-- Only the <style> section above is updated for 35% smaller UI -->
  
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-user-clock"></i></div>
        <div class="logo-text">Attendance</div>
      </div>
      <button class="toggle-btn" id="toggleSidebar"><i class="fas fa-chevron-left"></i></button>
    </div>
    <div class="nav-links" id="navLinks"></div>
    <div class="user-info" id="userInfo">
      <div class="avatar" id="sidebarAvatar">U</div>
      <div class="user-details">
        <div class="user-name" id="sidebarUserName">Loading...</div>
        <div class="user-email" id="sidebarUserEmail">Loading...</div>
      </div>
    </div>
  </div>
  <div class="main-content">
    <div class="container">
      <div class="header">
        <div>
          <h1 class="form-title">Attendance Log</h1>
          <div class="date-controls">
            <button id="prevDayBtn" class="nav-btn"><i class="fas fa-chevron-left"></i></button>
            <input type="date" id="datePicker" class="date-picker">
            <button id="nextDayBtn" class="nav-btn"><i class="fas fa-chevron-right"></i></button>
            <div id="currentDateDisplay" class="current-date-display"></div>
          </div>
        </div>
        <button id="scanBtn" class="scan-btn"><i class="fas fa-camera"></i> Scan Face</button>
      </div>
      <div id="workModeSelection" class="work-mode-selection">
        <h3 class="work-mode-title">Select Your Work Mode</h3>
        <div class="work-mode-options">
          <div class="work-mode-option" id="wfoOption" data-mode="wfo">
            <div class="work-mode-icon"><i class="fas fa-building"></i></div>
            <div class="work-mode-label">Work From Office (WFO)</div>
            <div class="work-mode-desc">At company premises</div>
          </div>
          <div class="work-mode-option" id="wfhOption" data-mode="wfh">
            <div class="work-mode-icon"><i class="fas fa-home"></i></div>
            <div class="work-mode-label">Work From Home (WFH)</div>
            <div class="work-mode-desc">At your registered location</div>
          </div>
        </div>
        <div class="radius-info">
          <strong>Office Location:</strong> Setapak Central<br>
          <strong>Allowed Radius:</strong> 100 meters for WFO, 500 meters for WFH
        </div>
      </div>
      <div id="debugLocation" class="debug-location">
        <strong>📍 Detected:</strong> <span id="debugCoords">--</span> (Accuracy: <span id="debugAccuracy">--</span>m)
      </div>
      <div id="cameraContainer" class="camera-container">
        <h3>Position your face clearly</h3>
        <div id="cameraError" class="camera-error"></div>
        <video id="videoFeed" autoplay playsinline muted></video>
        <div id="locationRadiusDisplay" class="location-radius-display">
          <div class="location-radius-title">Location Status</div>
          <div class="location-radius-status">
            <div class="location-radius-dot" id="locationRadiusDot"></div>
            <span id="locationRadiusText">Getting location...</span>
            <span class="location-radius-distance" id="locationRadiusDistance"></span>
          </div>
        </div>
        <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
        <br>
        <button id="captureBtn" class="scan-btn capture-btn"><i class="fas fa-bolt"></i> Capture & Recognize</button>
      </div>
      <div id="message" class="message"></div>
      <table class="attendance-table" id="attendanceTable">
        <thead><tr><th>Name</th><th>Date</th><th>Punch In Time</th><th>Punch Out Time</th><th>Status</th><th>Action</th></tr></thead>
        <tbody id="attendanceBody"></tbody>
      </table>
      <div id="emptyState" class="message" style="display:none;">No attendance records found for this date</div>
      <div id="locationMap"></div>
      <div id="locationInfo"></div>
      <div id="locationStatusDisplay"></div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    // >>>> KEEP THE ENTIRE JAVASCRIPT EXACTLY AS IN ORIGINAL <<<<
    // (No changes needed — only visual layer updated)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      collection,
      query,
      where,
      getDocs,
      setDoc,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
    const firebaseConfig = {
      apiKey:"AIzaSyB3nU-WVQ-7zm9RijUhj420QPET9GYQpj8",
      authDomain:"login-form-84016.firebaseapp.com",
      projectId:"login-form-84016",
      storageBucket:"login-form-84016.firebasestorage.app",
      messagingSenderId:"568483509830",
      appId:"1:568483509830:web:0d6de2a1537154bd67fc47",
      measurementId:"G-KCGTMGB6HB"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    // ... (rest of JS unchanged)
    // [PASTE THE ENTIRE ORIGINAL JAVASCRIPT HERE — no modifications]
    const navLinks = document.getElementById("navLinks");
    const sidebarAvatar = document.getElementById("sidebarAvatar");
    const sidebarUserName = document.getElementById("sidebarUserName");
    const sidebarUserEmail = document.getElementById("sidebarUserEmail");
    const scanBtn = document.getElementById("scanBtn");
    const cameraContainer = document.getElementById("cameraContainer");
    const videoFeed = document.getElementById("videoFeed");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");
    const messageDiv = document.getElementById("message");
    const attendanceBody = document.getElementById("attendanceBody");
    const emptyState = document.getElementById("emptyState");
    const table = document.getElementById("attendanceTable");
    const datePicker = document.getElementById("datePicker");
    const currentDateDisplay = document.getElementById("currentDateDisplay");
    const prevDayBtn = document.getElementById("prevDayBtn");
    const nextDayBtn = document.getElementById("nextDayBtn");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const cameraErrorDiv = document.getElementById("cameraError");
    const locationRadiusDisplay = document.getElementById("locationRadiusDisplay");
    const locationRadiusDot = document.getElementById("locationRadiusDot");
    const locationRadiusText = document.getElementById("locationRadiusText");
    const locationRadiusDistance = document.getElementById("locationRadiusDistance");
    const workModeSelection = document.getElementById("workModeSelection");
    const wfoOption = document.getElementById("wfoOption");
    const wfhOption = document.getElementById("wfhOption");
    const locationStatusDisplay = document.getElementById("locationStatusDisplay");
    const debugLocation = document.getElementById("debugLocation");
    const debugCoords = document.getElementById("debugCoords");
    const debugAccuracy = document.getElementById("debugAccuracy");
    let stream = null, allRecords = [], currentDate = new Date(), currentUid = null;
    let selectedWorkMode = null;
    let homeLocation = { lat: 3.205170, lng: 101.720107 };
    const OFFICE_LAT = 3.205170;
    const OFFICE_LNG = 101.720107;
    const WFO_RADIUS = 100;
    const WFH_RADIUS = 500;
    let isProcessing = false;
    function showLoading(text = "Processing...") {
      loadingOverlay.style.display = "flex";
      loadingOverlay.querySelector("p").textContent = text;
    }
    function hideLoading() { loadingOverlay.style.display = "none"; }
    function showMessage(text, type) {
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
      setTimeout(() => messageDiv.style.display = 'none', 5000);
    }
    function showCameraError(text) {
      cameraErrorDiv.textContent = text;
      cameraErrorDiv.style.display = 'block';
      setTimeout(() => cameraErrorDiv.style.display = 'none', 5000);
    }
    function addNavLink(text, icon, link, isActive = false) {
      const li = document.createElement("a");
      li.className = `nav-item ${isActive ? 'active' : ''}`;
      li.href = link;
      li.innerHTML = `<i class="fas ${icon}"></i><span>${text}</span>`;
      navLinks.appendChild(li);
    }
    function buildNavigation() {
      navLinks.innerHTML = "";
      addNavLink("Dashboard", "fa-home", "/dashboard");
      addNavLink("Attendance Log", "fa-list", "/attendance", true);
      addNavLink("Leave Requests", "fa-calendar-alt", "/leavecalendar");
      addNavLink("Profile", "fa-user", "/profile");
      const logout = document.createElement("a");
      logout.className = "nav-item";
      logout.href = "#";
      logout.innerHTML = '<i class="fas fa-sign-out-alt"></i><span>Logout</span>';
      logout.addEventListener("click", (e) => {
        e.preventDefault();
        signOut(auth).then(() => window.location.href = "/");
      });
      navLinks.appendChild(logout);
    }
    function formatDate(d) { return d.toISOString().split('T')[0]; }
    function formatDisplayDate(d) { return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
    function updateCurrentDateDisplay(d) { currentDateDisplay.textContent = formatDisplayDate(d); }
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function getLocationStatusText(distance, mode) {
      if (mode === 'wfo') {
        if (distance < 50) return "At Office";
        else if (distance < 500) return "Near Office";
        else return "Far from Office";
      } else {
        if (distance < 50) return "At Home";
        else if (distance < 500) return "Near Home";
        else return "Far from Home";
      }
    }
    function getLocationStatus(distance, mode) {
      const statusText = getLocationStatusText(distance, mode);
      if (statusText.includes("At ")) {
        return { text: statusText, color: "green", distance: `${distance.toFixed(1)}m` };
      } else if (statusText.includes("Near ")) {
        return { text: statusText, color: "yellow", distance: `${distance.toFixed(1)}m` };
      } else {
        return { text: statusText, color: "red", distance: `${distance.toFixed(1)}m` };
      }
    }
    function updateLocationRadiusDisplay(lat, lng) {
      if (!selectedWorkMode) {
        locationRadiusDisplay.style.display = 'none';
        return;
      }
      let distance = selectedWorkMode === 'wfo'
        ? calculateDistance(OFFICE_LAT, OFFICE_LNG, lat, lng)
        : calculateDistance(homeLocation.lat, homeLocation.lng, lat, lng);
      const status = getLocationStatus(distance, selectedWorkMode);
      locationRadiusDisplay.style.display = 'block';
      locationRadiusText.textContent = status.text;
      locationRadiusDistance.textContent = status.distance;
      locationRadiusDot.className = 'location-radius-dot';
      locationRadiusDot.classList.add(status.color === 'green' ? 'location-radius-green' : status.color === 'yellow' ? 'location-radius-yellow' : 'location-radius-red');
    }
    function validateLocation(lat, lng) {
      if (!selectedWorkMode) return { valid: false, message: "Please select a work mode first" };
      const distance = selectedWorkMode === 'wfo'
        ? calculateDistance(OFFICE_LAT, OFFICE_LNG, lat, lng)
        : calculateDistance(homeLocation.lat, homeLocation.lng, lat, lng);
      const allowed = selectedWorkMode === 'wfo' ? WFO_RADIUS : WFH_RADIUS;
      if (distance <= allowed) {
        return { valid: true, message: `You are ${distance.toFixed(1)}m from ${selectedWorkMode === 'wfo' ? 'office' : 'home'}` };
      } else {
        return { valid: false, message: `You are ${distance.toFixed(1)}m away. Must be within ${allowed}m for ${selectedWorkMode.toUpperCase()}` };
      }
    }
    function hasCheckedInToday() {
      const today = formatDate(new Date());
      return allRecords.some(record => {
        const recordDate = record.timestamp ? new Date(record.timestamp) : new Date(record.checkin);
        return formatDate(recordDate) === today;
      });
    }
    async function handleCheckout(docId) {
      if (!docId) return;
      showLoading("Checking out...");
      try {
        const now = new Date();
        const checkoutTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        await updateDoc(doc(db, "attendance_test", docId), { checkout: checkoutTime });
        showMessage("✅ Checked out!", "success");
        loadAllAttendanceRecords();
      } catch (error) {
        console.error("Checkout error:", error);
        showMessage("❌ Failed to check out", "error");
      } finally {
        hideLoading();
      }
    }
    async function loadAllAttendanceRecords() {
      showLoading("Loading attendance...");
      try {
        if (!currentUid) {
          hideLoading();
          return;
        }
        const q = query(collection(db, "attendance_test"), where("userId", "==", currentUid));
        const querySnapshot = await getDocs(q);
        allRecords = [];
        querySnapshot.forEach(doc => allRecords.push({ id: doc.id, ...doc.data() }));
        const todayCheckedIn = hasCheckedInToday();
        scanBtn.disabled = todayCheckedIn;
        scanBtn.classList.toggle('disabled', todayCheckedIn);
        scanBtn.innerHTML = todayCheckedIn
          ? '<i class="fas fa-check-circle"></i> Already Checked In Today'
          : '<i class="fas fa-camera"></i> Scan Face';
        displayRecordsForDate(formatDate(currentDate));
      } catch (e) {
        console.error("Firestore error:", e);
        showMessage("Failed to load attendance: " + e.message, "error");
      } finally {
        hideLoading();
      }
    }
    function displayRecordsForDate(ds) {
      const f = allRecords.filter(r => {
        const recordDate = r.timestamp ? new Date(r.timestamp) : new Date(r.checkin);
        return formatDate(recordDate) === ds;
      });
      const mapDiv = document.getElementById("locationMap");
      const infoDiv = document.getElementById("locationInfo");
      const statusDiv = document.getElementById("locationStatusDisplay");
      if (!f.length) {
        emptyState.style.display = 'block';
        table.style.display = 'none';
        mapDiv.style.display = 'none';
        infoDiv.style.display = 'none';
        statusDiv.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        table.style.display = 'table';
        attendanceBody.innerHTML = '';
        const latest = f[0];
        if (latest.latitude != null && latest.longitude != null) {
          if (window.attendanceMap) {
            window.attendanceMap.remove();
            window.attendanceMap = null;
          }
          const lat = parseFloat(latest.latitude);
          const lng = parseFloat(latest.longitude);
          window.attendanceMap = L.map('locationMap').setView([lat, lng], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(window.attendanceMap);
          const popupContent = `<b>${latest.name}</b><br><strong>${latest.status}</strong><br><em>${latest.address}</em>`;
          L.marker([lat, lng]).addTo(window.attendanceMap).bindPopup(popupContent).openPopup();
          L.circle([lat, lng], { color: '#667eea', fillColor: '#667eea', fillOpacity: 0.2, radius: 50 }).addTo(window.attendanceMap);
          mapDiv.style.display = 'block';
          infoDiv.innerHTML = `<strong>📍 Location:</strong> ${latest.address}`;
          infoDiv.style.display = 'block';
          let locationStatusText = latest.locationStatus || 'Unknown';
          let statusClass = locationStatusText.includes("At ") ? 'location-status-green' :
                           locationStatusText.includes("Near ") ? 'location-status-yellow' : 'location-status-red';
          statusDiv.innerHTML = `
            <strong>📍 Location Status:</strong>
            <span class="location-status-text">
              <span class="location-status-dot ${statusClass}"></span>
              ${locationStatusText}
            </span>
          `;
          statusDiv.style.display = 'block';
        } else {
          mapDiv.style.display = 'none';
          infoDiv.style.display = 'none';
          statusDiv.style.display = 'none';
        }
        f.forEach(r => {
          const d = r.timestamp ? new Date(r.timestamp) : new Date(r.checkin);
          const statusClass = r.status === "On Time" ? "on-time" : "late";
          const isToday = formatDate(d) === formatDate(new Date());
          const canCheckout = isToday && !r.checkout;
          attendanceBody.innerHTML += `
            <tr>
              <td>${r.name || 'N/A'}</td>
              <td>${d.toLocaleDateString()}</td>
              <td>${d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
              <td>${r.checkout || (canCheckout ? '<em>-</em>' : 'N/A')}</td>
              <td><span class="status ${statusClass}">${r.status}</span></td>
              <td>
                ${canCheckout ? 
                  `<button class="checkout-btn" data-id="${r.id}">
                    <i class="fas fa-sign-out-alt"></i> Check Out
                  </button>` : ''
                }
              </td>
            </tr>`;
        });
        document.querySelectorAll('.checkout-btn').forEach(button => {
          button.addEventListener('click', (e) => handleCheckout(e.currentTarget.dataset.id));
        });
      }
    }
    async function handleWorkModeSelection(mode) {
      selectedWorkMode = mode;
      wfoOption.classList.toggle('selected', mode === 'wfo');
      wfhOption.classList.toggle('selected', mode === 'wfh');
      if (mode === 'wfh') {
        showLoading("Detecting and saving your home location...");
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 0
            });
          });
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const accuracy = position.coords.accuracy;
          if (accuracy > 100) {
            const confirmed = confirm(
              `⚠️ Location accuracy is low (${accuracy.toFixed(0)}m).
` +
              `Detected: ${lat.toFixed(6)}, ${lng.toFixed(6)}
` +
              `Continue anyway?`
            );
            if (!confirmed) {
              hideLoading();
              selectedWorkMode = null;
              wfhOption.classList.remove('selected');
              scanBtn.style.display = 'inline-flex';
              workModeSelection.style.display = 'block';
              return;
            }
          }
          homeLocation = { lat, lng };
          await updateDoc(doc(db, "users", currentUid), { homeLocation: { lat, lng } });
          showMessage(`✅ Home location saved! Accuracy: ±${accuracy.toFixed(0)}m`, "success");
          debugCoords.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          debugAccuracy.textContent = accuracy.toFixed(0);
          debugLocation.style.display = 'block';
        } catch (err) {
          console.error("Auto-save location error:", err);
          let msg = "Failed to get location. Please ensure location services are enabled.";
          if (err.code === 1) msg = "Location permission denied.";
          showMessage(msg, "error");
          selectedWorkMode = null;
          wfhOption.classList.remove('selected');
          hideLoading();
          scanBtn.style.display = 'inline-flex';
          workModeSelection.style.display = 'block';
          return;
        }
      } else {
        debugLocation.style.display = 'none';
      }
      hideLoading();
      workModeSelection.style.display = 'none';
      scanBtn.style.display = 'none';
      cameraContainer.style.display = 'block';
      startCamera();
    }
    async function startCamera() {
      try {
        if (stream) stream.getTracks().forEach(track => track.stop());
        const constraints = { video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoFeed.srcObject = stream;
        videoFeed.onloadedmetadata = () => videoFeed.play();
        videoFeed.onerror = () => showCameraError("Failed to start camera.");
        startLocationTracking();
      } catch (err) {
        let msg = "Camera access denied or not available.";
        if (err.name === "NotAllowedError") msg = "Please allow camera access in browser settings.";
        else if (err.name === "NotFoundError") msg = "No camera found.";
        else if (err.name === "NotReadableError") msg = "Camera in use by another app.";
        showCameraError(msg);
        stopCamera();
      }
    }
    function startLocationTracking() {
      if (window.locationWatchId) navigator.geolocation.clearWatch(window.locationWatchId);
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          updateLocationRadiusDisplay(latitude, longitude);
          window.locationWatchId = navigator.geolocation.watchPosition(
            (p) => updateLocationRadiusDisplay(p.coords.latitude, p.coords.longitude),
            (e) => console.warn("Location tracking error:", e),
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
          );
        },
        (e) => {
          locationRadiusDisplay.style.display = 'block';
          locationRadiusText.textContent = "Location unavailable";
          locationRadiusDot.className = 'location-radius-dot location-radius-red';
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    }
    scanBtn.addEventListener('click', () => {
      if (hasCheckedInToday()) return showMessage("You have already checked in today!", "error");
      workModeSelection.style.display = 'block';
      scanBtn.style.display = 'none';
    });
    wfoOption.addEventListener('click', () => handleWorkModeSelection('wfo'));
    wfhOption.addEventListener('click', () => handleWorkModeSelection('wfh'));
    captureBtn.addEventListener('click', async () => {
      if (isProcessing) return;
      isProcessing = true;
      captureBtn.disabled = true;
      captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
      if (!videoFeed.srcObject || videoFeed.videoWidth === 0) {
        showCameraError("Camera is not ready.");
        isProcessing = false;
        captureBtn.disabled = false;
        captureBtn.innerHTML = '<i class="fas fa-bolt"></i> Capture & Recognize';
        return;
      }
      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoFeed, 0, 0, canvas.width, canvas.height);
      const img = canvas.toDataURL('image/png');
      const expectedName = sidebarUserName.textContent.trim();
      let lat = null, lng = null;
      showLoading("Getting your location...");
      try {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          });
        });
        lat = pos.coords.latitude;
        lng = pos.coords.longitude;
      } catch (err) {
        showMessage("Location access denied. Please enable location services.", "error");
        stopCamera();
        isProcessing = false;
        captureBtn.disabled = false;
        captureBtn.innerHTML = '<i class="fas fa-bolt"></i> Capture & Recognize';
        return;
      }
      const validation = validateLocation(lat, lng);
      if (!validation.valid) {
        showMessage(validation.message, "error");
        stopCamera();
        isProcessing = false;
        captureBtn.disabled = false;
        captureBtn.innerHTML = '<i class="fas fa-bolt"></i> Capture & Recognize';
        return;
      }
      let distance = selectedWorkMode === 'wfo'
        ? calculateDistance(OFFICE_LAT, OFFICE_LNG, lat, lng)
        : calculateDistance(homeLocation.lat, homeLocation.lng, lat, lng);
      const locationStatus = getLocationStatusText(distance, selectedWorkMode);
      showLoading("Recognizing face...");
      try {
        const BACKEND_URL = window.location.hostname.includes("web.app") ?
          "https://your-flask-backend.onrender.com" : "http://127.0.0.1:5000";
        const res = await fetch(`${BACKEND_URL}/recognize`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: img, expected_name: expectedName, user_uid: currentUid, latitude: lat, longitude: lng, work_mode: selectedWorkMode })
        });
        const result = await res.json();
        if (result.success) {
          const today = new Date().toISOString().split('T')[0];
          const docId = `${currentUid}_${today}`;
          const docRef = doc(db, "attendance_test", docId);
          const q = query(collection(db, "attendance_test"), where("userId", "==", currentUid));
          const querySnapshot = await getDocs(q);
          const batch = writeBatch(db);
          querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const recordDate = data.timestamp
              ? new Date(data.timestamp)
              : data.checkin
                ? new Date()
                : null;
            if (recordDate && formatDate(recordDate) === today) {
              if (
                docSnap.id !== docId ||
                !data.timestamp ||
                typeof data.timestamp !== 'string' ||
                isNaN(new Date(data.timestamp).getTime())
              ) {
                batch.delete(docSnap.ref);
              }
            }
          });
          await batch.commit();
          const now = new Date();
          const attendanceData = {
            userId: currentUid,
            name: result.name,
            status: result.status,
            checkin: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            timestamp: now.toISOString(),
            latitude: lat,
            longitude: lng,
            address: result.address || "Unknown Location",
            workMode: selectedWorkMode,
            locationStatus: locationStatus,
            checkout: null
          };
          await setDoc(docRef, attendanceData);
          showMessage(`✅ ${result.status}! Verified: ${result.name}`, "success");
          loadAllAttendanceRecords();
        } else {
          showMessage(`❌ ${result.error || "Recognition failed"}`, "error");
        }
      } catch (err) {
        console.error("Recognition or cleanup error:", err);
        showMessage("⚠️ Failed to process check-in", "error");
      } finally {
        hideLoading();
        stopCamera();
        isProcessing = false;
        captureBtn.disabled = false;
        captureBtn.innerHTML = '<i class="fas fa-bolt"></i> Capture & Recognize';
      }
    });
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      if (window.locationWatchId) {
        navigator.geolocation.clearWatch(window.locationWatchId);
        window.locationWatchId = null;
      }
      cameraContainer.style.display = 'none';
      scanBtn.style.display = 'inline-flex';
      workModeSelection.style.display = 'none';
      selectedWorkMode = null;
      cameraErrorDiv.style.display = 'none';
      locationRadiusDisplay.style.display = 'none';
      debugLocation.style.display = 'none';
    }
    datePicker.addEventListener('change', () => {
      currentDate = new Date(datePicker.value);
      updateCurrentDateDisplay(currentDate);
      displayRecordsForDate(datePicker.value);
    });
    prevDayBtn.addEventListener('click', () => {
      currentDate.setDate(currentDate.getDate() - 1);
      datePicker.value = formatDate(currentDate);
      updateCurrentDateDisplay(currentDate);
      displayRecordsForDate(datePicker.value);
    });
    nextDayBtn.addEventListener('click', () => {
      currentDate.setDate(currentDate.getDate() + 1);
      datePicker.value = formatDate(currentDate);
      updateCurrentDateDisplay(currentDate);
      displayRecordsForDate(datePicker.value);
    });
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUid = user.uid;
        const docSnap = await getDoc(doc(db, "users", user.uid));
        if (docSnap.exists()) {
          const x = docSnap.data();
          sidebarUserName.textContent = x.firstName || "User";
          sidebarUserEmail.textContent = x.email || user.email;
          sidebarAvatar.textContent = (x.firstName?.[0] || "U").toUpperCase();
          if (x.homeLocation) {
            homeLocation = x.homeLocation;
          }
        }
        buildNavigation();
        datePicker.value = formatDate(new Date());
        updateCurrentDateDisplay(new Date());
        loadAllAttendanceRecords();
      } else {
        window.location.href = "/";
      }
    });
    document.getElementById("toggleSidebar").addEventListener("click", () => {
      const s = document.getElementById("sidebar");
      s.classList.toggle("collapsed");
      const i = document.querySelector("#toggleSidebar i");
      i.className = s.classList.contains("collapsed") ? "fas fa-chevron-right" : "fas fa-chevron-left";
    });
  </script>
</body>
</html>
