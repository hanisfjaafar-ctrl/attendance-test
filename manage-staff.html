<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Management</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background: linear-gradient(135deg, #667eea, #764ba2);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      display: flex;
    }
    /* ===== SIDEBAR (EXACT MATCH TO REFERENCE) ===== */
    .sidebar {
      width: 140px;
      background: rgba(255, 255, 255, 0.95);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      box-shadow: 3px 0 15px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }
    .sidebar.expanded {
      width: 220px;
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }
      .sidebar.expanded {
        width: 220px;
      }
    }
    .sidebar-header {
      padding: 15px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }
    .logo-text {
      font-size: 1.1rem;
      font-weight: 700;
      color: #333;
      white-space: nowrap;
    }
    .sidebar:not(.expanded) .logo-text {
      display: none;
    }
    .toggle-btn {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      color: #667eea;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    .toggle-btn:hover {
      background: rgba(102, 126, 234, 0.1);
    }
    .nav-links {
      padding: 12px 0;
      flex: 1;
    }
    .nav-item {
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: #555;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      cursor: pointer;
      white-space: nowrap;
    }
    .nav-item:hover, .nav-item.active {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      border-left: 3px solid #667eea;
    }
    .nav-item i {
      font-size: 1rem;
      width: 20px;
      text-align: center;
    }
    .sidebar:not(.expanded) .nav-item span {
      display: none;
    }
    .sidebar:not(.expanded) .nav-item {
      justify-content: center;
      padding: 12px;
      gap: 0;
    }
    .user-info {
      padding: 12px;
      border-top: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
      text-transform: uppercase;
    }
    .user-details {
      flex: 1;
    }
    .user-name {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }
    .user-email {
      font-size: 0.75rem;
      color: #777;
    }
    .sidebar:not(.expanded) .user-details {
      display: none;
    }
    /* ===== MAIN CONTENT ===== */
    .main-content {
      flex: 1;
      padding: 15px;
      margin-left: 140px;
      transition: margin-left 0.3s ease;
    }
    .sidebar.expanded ~ .main-content {
      margin-left: 220px;
    }
    @media (max-width: 768px) {
      .main-content {
        margin-left: 60px;
        padding: 12px;
      }
      .sidebar.expanded ~ .main-content {
        margin-left: 220px;
      }
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      font-size: 1.8rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      position: relative;
    }
    h2::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 2px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 2px;
    }
    /* ===== STAFF STATS ===== */
    .stats-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      border-radius: 12px;
      flex: 1;
      min-width: 150px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 8px 0;
    }
    .stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    /* ===== STAFF TABLE ===== */
    .staff-table-container {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
    }
    thead {
      background: linear-gradient(to right, #667eea, #764ba2);
      color: white;
    }
    th {
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      font-size: 0.85rem;
    }
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      font-size: 0.85rem;
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:hover {
      background-color: #f8f9fa;
    }
    .status {
      padding: 4px 10px;
      border-radius: 18px;
      font-weight: 600;
      font-size: 0.75rem;
      display: inline-block;
    }
    .status-active {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .status-inactive {
      background: #ffebee;
      color: #c62828;
    }
    .status-green {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 3px 7px;
      border-radius: 4px;
      font-size: 0.75rem;
    }
    .status-red {
      background: #ffebee;
      color: #c62828;
      padding: 3px 7px;
      border-radius: 4px;
      font-size: 0.75rem;
    }
    .clickable-name {
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
      font-size: 0.85rem;
    }
    .clickable-name:hover {
      color: #5a6fd8;
    }
    .action-btn {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
    }
    .btn-disable {
      background: #ff9800;
      color: white;
    }
    .btn-disable:hover {
      background: #f57c00;
    }
    .btn-delete {
      background: #f44336;
      color: white;
    }
    .btn-delete:hover {
      background: #d32f2f;
    }
    /* ===== STAFF DETAILS PAGE ===== */
    .staff-details-page {
      display: none;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      background: #fff;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 999;
    }
    .details-header {
      background: white;
      padding: 15px 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .back-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s;
      font-size: 0.85rem;
    }
    .back-btn:hover {
      background: #5a6fd8;
      transform: translateY(-2px);
    }
    .staff-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px 25px;
      border-bottom: 1px solid #eee;
    }
    .staff-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
      text-transform: uppercase;
    }
    .staff-info {
      flex: 1;
    }
    .staff-name {
      font-size: 1.6rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }
    .staff-role {
      font-size: 1rem;
      color: #667eea;
      font-weight: 600;
    }
    .staff-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 18px;
      font-weight: 600;
      margin-top: 8px;
      font-size: 0.85rem;
    }
    /* ===== TAB NAVIGATION ===== */
    .tabs {
      display: flex;
      padding: 0 25px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      font-size: 0.85rem;
      position: relative;
      transition: all 0.3s;
    }
    .tab:hover {
      color: #667eea;
    }
    .tab.active {
      color: #667eea;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 2px;
      background: #667eea;
    }
    /* ===== TAB CONTENT ===== */
    .tab-content {
      display: none;
      padding: 20px 25px;
      flex: 1;
      overflow-y: auto;
    }
    .tab-content.active {
      display: block;
    }
    .details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    .detail-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    .detail-card h3 {
      margin-bottom: 15px;
      color: #667eea;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
    }
    .detail-card ul {
      list-style: none;
    }
    .detail-card li {
      padding: 10px 0;
      border-bottom: 1px dashed #eee;
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
    }
    .detail-card li:last-child {
      border-bottom: none;
    }
    .detail-card .label {
      color: #555;
      font-weight: 500;
    }
    .detail-card .value {
      font-weight: 600;
      color: #333;
      text-align: right;
    }
    /* ===== EMERGENCY CONTACT CARD ===== */
    .emergency-card {
      background: #fff8e1;
      border-left: 3px solid #f57f17;
    }
    .emergency-card h3 {
      color: #f57f17;
    }
    /* ===== FILTER CONTROLS ===== */
    .filter-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .filter-group label {
      font-weight: 600;
      color: #555;
      font-size: 0.85rem;
    }
    .filter-group select, .filter-group input {
      padding: 10px;
      border: 2px solid #e0e6ed;
      border-radius: 6px;
      font-size: 0.85rem;
      width: 120px;
    }
    .filter-group select:focus, .filter-group input:focus {
      border-color: #667eea;
      outline: none;
    }
    /* ===== ATTENDANCE & LEAVE TABLES ===== */
    .data-table-container {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      margin-top: 12px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
    }
    .data-table thead {
      background: linear-gradient(to right, #667eea, #764ba2);
      color: white;
    }
    .data-table th {
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      font-size: 0.85rem;
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }
    .data-table tr:hover {
      background-color: #f8f9fa;
    }
    /* ===== LOADING OVERLAY ===== */
    #loadingOverlay {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background: rgba(102, 126, 234, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      color: #fff;
      font-size: 14px;
      backdrop-filter: blur(10px);
      font-family: 'Poppins', sans-serif;
    }
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      padding: 30px 15px;
      color: #7f8c8d;
    }
    .empty-state i {
      font-size: 2rem;
      margin-bottom: 12px;
      color: #bdc3c7;
    }
    .empty-state h3 {
      margin-bottom: 8px;
      color: #2c3e50;
      font-size: 1.2rem;
    }
    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
      }
      .sidebar .logo-text,
      .sidebar .user-details,
      .sidebar .nav-item span {
        display: none;
      }
      .sidebar .nav-item {
        justify-content: center;
        padding: 12px;
        gap: 0;
      }
      .main-content {
        margin-left: 60px;
        padding: 12px;
      }
      .container {
        padding: 18px;
      }
      h2 {
        font-size: 1.5rem;
      }
      .stats-container {
        flex-direction: column;
      }
      .stat-card {
        min-width: 100%;
      }
      th, td {
        padding: 10px 8px;
        font-size: 0.8rem;
      }
      .details-grid {
        grid-template-columns: 1fr;
      }
      .staff-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .staff-avatar {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      .staff-name {
        font-size: 1.4rem;
      }
      .tabs {
        padding: 0 15px;
      }
      .tab {
        padding: 10px 12px;
        font-size: 0.8rem;
      }
      .tab-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading staff data...</p>
  </div>
  <!-- Sidebar Navigation (EXACT MATCH TO REFERENCE) -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-user-clock"></i>
        </div>
        <div class="logo-text">Attendance</div>
      </div>
      <button class="toggle-btn" id="toggleBtn">
        <i class="fas fa-chevron-left"></i>
      </button>
    </div>
    <div class="nav-links" id="navLinks">
      <!-- Navigation items will be populated by JavaScript -->
    </div>
    <div class="user-info" id="userInfo">
      <div class="avatar" id="sidebarAvatar">U</div>
      <div class="user-details">
        <div class="user-name" id="sidebarUserName">Loading...</div>
        <div class="user-email" id="sidebarUserEmail">Loading...</div>
      </div>
    </div>
  </div>
  <!-- Staff List Page -->
  <div class="main-content" id="staffListPage">
    <div class="container">
      <h2>Staff Management</h2>
      <!-- Stats Cards -->
      <div class="stats-container">
        <div class="stat-card">
          <i class="fas fa-users fa-lg"></i>
          <div class="stat-value" id="totalStaff">0</div>
          <div class="stat-label">Total Staff</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-user-check fa-lg"></i>
          <div class="stat-value" id="activeStaff">0</div>
          <div class="stat-label">Active Staff</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-user-times fa-lg"></i>
          <div class="stat-value" id="inactiveStaff">0</div>
          <div class="stat-label">Inactive Staff</div>
        </div>
      </div>
      <!-- Staff Table -->
      <div class="staff-table-container">
        <table id="staffTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="staffBody">
            <!-- Staff records will be populated here -->
          </tbody>
        </table>
        <div id="staffEmptyState" class="empty-state" style="display: none;">
          <i class="fas fa-users"></i>
          <h3>No Staff Members Found</h3>
          <p>There are no staff members in the system.</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Staff Details Page -->
  <div class="staff-details-page" id="staffDetailsPage">
    <div class="details-header">
      <button class="back-btn" id="backToStaffList">
        <i class="fas fa-arrow-left"></i> Back to Staff List
      </button>
      <div class="staff-status" id="detailsStatus">Active</div>
    </div>
    <div class="staff-header">
      <div class="staff-avatar" id="detailsAvatar">JD</div>
      <div class="staff-info">
        <h1 class="staff-name" id="detailsName">John Doe</h1>
        <div class="staff-role" id="detailsRole">Staff Member</div>
      </div>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="profile">Profile</div>
      <div class="tab" data-tab="attendance">Attendance Summary</div>
      <div class="tab" data-tab="attendance-log">Attendance Log</div>
      <div class="tab" data-tab="leave-requests">Leave Requests</div>
    </div>
    <div class="tab-content active" id="profile-tab">
      <div class="details-grid">
        <div class="detail-card">
          <h3><i class="fas fa-user"></i> Personal Information</h3>
          <ul>
            <li><span class="label">Full Name:</span> <span class="value" id="detailsFullName">-</span></li>
            <li><span class="label">Email:</span> <span class="value" id="detailsEmail">-</span></li>
            <li><span class="label">Department:</span> <span class="value" id="detailsDepartment">-</span></li>
            <li><span class="label">Position:</span> <span class="value" id="detailsPosition">-</span></li>
            <li><span class="label">Phone:</span> <span class="value" id="detailsPhone">-</span></li>
            <li><span class="label">Address:</span> <span class="value" id="detailsAddress">-</span></li>
            <li><span class="label">Joined:</span> <span class="value" id="detailsJoinDate">-</span></li>
            <li><span class="label">Work Duration:</span> <span class="value" id="detailsWorkDuration">-</span></li>
          </ul>
        </div>
        <div class="detail-card emergency-card">
          <h3><i class="fas fa-ambulance"></i> Emergency Contact</h3>
          <ul>
            <li><span class="label">Name:</span> <span class="value" id="emergencyName">-</span></li>
            <li><span class="label">Relationship:</span> <span class="value" id="emergencyRelation">-</span></li>
            <li><span class="label">Phone:</span> <span class="value" id="emergencyPhone">-</span></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="tab-content" id="attendance-tab">
      <div class="details-grid">
        <div class="detail-card">
          <h3><i class="fas fa-calendar-check"></i> Attendance Summary</h3>
          <ul>
            <li><span class="label">Total Days Worked:</span> <span class="value" id="detailsTotalDays">-</span></li>
            <li><span class="label">Late Check-ins:</span> <span class="value" id="detailsLateCheckins">-</span></li>
            <li><span class="label">Remote Work Days:</span> <span class="value" id="detailsRemoteDays">-</span></li>
            <li><span class="label">On-time Rate:</span> <span class="value" id="detailsOnTimeRate">-</span></li>
            <li><span class="label">Average Check-in Time:</span> <span class="value" id="detailsAvgCheckin">-</span></li>
            <li><span class="label">Most Common Location:</span> <span class="value" id="detailsCommonLocation">-</span></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="tab-content" id="attendance-log-tab">
      <div class="filter-controls">
        <div class="filter-group">
          <label for="logYearFilter">Year</label>
          <select id="logYearFilter">
            <!-- Options will be populated dynamically -->
          </select>
        </div>
        <div class="filter-group">
          <label for="logMonthFilter">Month</label>
          <select id="logMonthFilter">
            <option value="all">All Months</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
      </div>
      <div class="data-table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Check-in</th>
              <th>Check-out</th>
              <th>Status</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody id="attendanceLogBody">
            <!-- Attendance log will be populated here -->
          </tbody>
        </table>
      </div>
      <div id="logEmptyState" class="empty-state" style="display: none; padding: 15px;">
        <i class="fas fa-clipboard-list"></i>
        <p>No attendance records found</p>
      </div>
    </div>
    <div class="tab-content" id="leave-requests-tab">
      <div class="filter-controls">
        <div class="filter-group">
          <label for="yearFilter">Year</label>
          <select id="yearFilter">
            <!-- Options will be populated dynamically -->
          </select>
        </div>
        <div class="filter-group">
          <label for="monthFilter">Month</label>
          <select id="monthFilter">
            <option value="all">All Months</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
      </div>
      <div class="data-table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Type</th>
              <th>Reason</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="leaveRequestsBody">
            <!-- Leave requests will be populated here -->
          </tbody>
        </table>
      </div>
      <div id="leaveEmptyState" class="empty-state" style="display: none; padding: 15px;">
        <i class="fas fa-calendar"></i>
        <p>No leave requests found</p>
      </div>
    </div>
  </div>
  <!-- Firebase JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      query, 
      where, 
      getDocs, 
      doc, 
      getDoc, 
      updateDoc, 
      deleteDoc 
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB3nU-WVQ-7zm9RijUhj420QPET9GYQpj8",
      authDomain: "login-form-84016.firebaseapp.com",
      projectId: "login-form-84016",
      storageBucket: "login-form-84016.firebasestorage.app",
      messagingSenderId: "568483509830",
      appId: "1:568483509830:web:0d6de2a1537154bd67fc47",
      measurementId: "G-KCGTMGB6HB"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    // DOM Elements
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("toggleBtn");
    const navLinks = document.getElementById("navLinks");
    const staffBody = document.getElementById("staffBody");
    const totalStaffEl = document.getElementById("totalStaff");
    const activeStaffEl = document.getElementById("activeStaff");
    const inactiveStaffEl = document.getElementById("inactiveStaff");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const sidebarAvatar = document.getElementById("sidebarAvatar");
    const sidebarUserName = document.getElementById("sidebarUserName");
    const sidebarUserEmail = document.getElementById("sidebarUserEmail");
    const staffListPage = document.getElementById("staffListPage");
    const staffDetailsPage = document.getElementById("staffDetailsPage");
    const backToStaffList = document.getElementById("backToStaffList");
    const detailsName = document.getElementById("detailsName");
    const detailsRole = document.getElementById("detailsRole");
    const detailsStatus = document.getElementById("detailsStatus");
    const detailsAvatar = document.getElementById("detailsAvatar");
    const detailsFullName = document.getElementById("detailsFullName");
    const detailsEmail = document.getElementById("detailsEmail");
    const detailsDepartment = document.getElementById("detailsDepartment");
    const detailsPosition = document.getElementById("detailsPosition");
    const detailsPhone = document.getElementById("detailsPhone");
    const detailsAddress = document.getElementById("detailsAddress");
    const detailsJoinDate = document.getElementById("detailsJoinDate");
    const detailsWorkDuration = document.getElementById("detailsWorkDuration");
    const emergencyName = document.getElementById("emergencyName");
    const emergencyRelation = document.getElementById("emergencyRelation");
    const emergencyPhone = document.getElementById("emergencyPhone");
    const detailsTotalDays = document.getElementById("detailsTotalDays");
    const detailsLateCheckins = document.getElementById("detailsLateCheckins");
    const detailsRemoteDays = document.getElementById("detailsRemoteDays");
    const detailsOnTimeRate = document.getElementById("detailsOnTimeRate");
    const detailsAvgCheckin = document.getElementById("detailsAvgCheckin");
    const detailsCommonLocation = document.getElementById("detailsCommonLocation");
    const leaveRequestsBody = document.getElementById("leaveRequestsBody");
    const attendanceLogBody = document.getElementById("attendanceLogBody");
    const staffEmptyState = document.getElementById("staffEmptyState");
    const leaveEmptyState = document.getElementById("leaveEmptyState");
    const logEmptyState = document.getElementById("logEmptyState");
    const yearFilter = document.getElementById("yearFilter");
    const monthFilter = document.getElementById("monthFilter");
    const logYearFilter = document.getElementById("logYearFilter");
    const logMonthFilter = document.getElementById("logMonthFilter");
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    // Global variables
    let currentUser = null;
    let currentStaffId = null;
    let allUsers = [];
    let allAttendance = [];
    let allLeaveRequests = [];
    // Toggle sidebar
    toggleBtn.addEventListener("click", () => {
      sidebar.classList.toggle("expanded");
      const icon = toggleBtn.querySelector("i");
      icon.className = sidebar.classList.contains("expanded") 
        ? "fas fa-chevron-left" 
        : "fas fa-chevron-right";
    });
    // Back to staff list
    backToStaffList.addEventListener("click", () => {
      staffListPage.style.display = "block";
      staffDetailsPage.style.display = "none";
      sidebar.style.display = "flex";
      const mainContent = document.querySelector('.main-content');
      mainContent.style.marginLeft = sidebar.classList.contains('expanded') ? '220px' : '140px';
    });
    // Tab navigation
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
    // Format date for display
    function formatDate(dateString) {
      if (!dateString) return "-";
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }
    // Format time for display
    function formatTime(timeString) {
      if (!timeString || timeString === "—" || !timeString.trim()) return "-";
      return timeString;
    }
    // Extract date from timestamp (YYYY-MM-DD HH:mm:ss → YYYY-MM-DD)
    function extractDateFromTimestamp(timestamp) {
      if (!timestamp || typeof timestamp !== 'string') return null;
      return timestamp.split(' ')[0];
    }
    // Calculate work duration
    function calculateWorkDuration(joinDate) {
      if (!joinDate) return "-";
      const join = new Date(joinDate);
      const now = new Date();
      const diffTime = Math.abs(now - join);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      const years = Math.floor(diffDays / 365);
      const months = Math.floor((diffDays % 365) / 30);
      if (years > 0) {
        return `${years} year${years > 1 ? 's' : ''} ${months} month${months !== 1 ? 's' : ''}`;
      }
      return `${months} month${months !== 1 ? 's' : ''}`;
    }
    // Get years from attendance data
    function getYearsFromData(data) {
      const years = new Set();
      data.forEach(item => {
        if (item.timestamp) {
          const datePart = extractDateFromTimestamp(item.timestamp);
          if (datePart) {
            const year = datePart.split('-')[0];
            years.add(year);
          }
        } else if (item.startDate) {
          const date = new Date(item.startDate);
          years.add(date.getFullYear().toString());
        }
      });
      return Array.from(years).sort((a, b) => b - a);
    }
    // Populate year filters
    function populateYearFilters() {
      const attendanceYears = getYearsFromData(allAttendance);
      const leaveYears = getYearsFromData(allLeaveRequests);
      const allYears = [...new Set([...attendanceYears, ...leaveYears])].sort((a, b) => b - a);
      const currentYear = new Date().getFullYear().toString();
      if (!allYears.includes(currentYear)) {
        allYears.unshift(currentYear);
      }
      yearFilter.innerHTML = '';
      logYearFilter.innerHTML = '';
      allYears.forEach(year => {
        const option1 = document.createElement('option');
        option1.value = year;
        option1.textContent = year;
        yearFilter.appendChild(option1);
        const option2 = document.createElement('option');
        option2.value = year;
        option2.textContent = year;
        logYearFilter.appendChild(option2);
      });
      yearFilter.value = currentYear;
      logYearFilter.value = currentYear;
    }
    // ✅ CORRECTED: Use actual field names from attendance_test
    function filterAttendance(userId, year, month) {
      return allAttendance.filter(record => {
        if (record.userId !== userId) return false;
        if (!record.timestamp) return false;
        const datePart = extractDateFromTimestamp(record.timestamp);
        if (!datePart) return false;
        const [recordYear, recordMonthStr] = datePart.split('-');
        const recordMonth = parseInt(recordMonthStr, 10);
        if (year && recordYear !== year) return false;
        if (month && month !== 'all' && recordMonth !== parseInt(month)) return false;
        return true;
      });
    }
    function filterLeaveRequests(userId, year, month) {
      return allLeaveRequests.filter(request => {
        if (request.userId !== userId) return false;
        if (!request.startDate) return false;
        const startDate = new Date(request.startDate);
        const requestYear = startDate.getFullYear().toString();
        const requestMonth = startDate.getMonth() + 1;
        if (year && requestYear !== year) return false;
        if (month && month !== 'all' && requestMonth !== parseInt(month)) return false;
        return true;
      });
    }
    // ✅ FIXED: Parse "01:24 pm" format
    function calculateAverageCheckin(attendanceData) {
      if (attendanceData.length === 0) return "-";
      let totalMinutes = 0;
      let validCount = 0;
      attendanceData.forEach(record => {
        const timeStr = record.checkin; // e.g., "01:24 pm"
        if (timeStr && timeStr !== "—") {
          const [time, period] = timeStr.trim().split(' ');
          if (time && period) {
            let [hours, minutes] = time.split(':').map(Number);
            if (period.toLowerCase() === 'pm' && hours !== 12) hours += 12;
            if (period.toLowerCase() === 'am' && hours === 12) hours = 0;
            if (!isNaN(hours) && !isNaN(minutes)) {
              totalMinutes += hours * 60 + minutes;
              validCount++;
            }
          }
        }
      });
      if (validCount === 0) return "-";
      const avgMinutes = Math.round(totalMinutes / validCount);
      const avgHours = Math.floor(avgMinutes / 60);
      const avgMins = avgMinutes % 60;
      return `${String(avgHours).padStart(2, '0')}:${String(avgMins).padStart(2, '0')}`;
    }
    // ✅ FIXED: Use locationStatus
    function findMostCommonLocation(attendanceData) {
      if (attendanceData.length === 0) return "-";
      const locationCount = {};
      attendanceData.forEach(record => {
        const location = record.locationStatus || "Unknown";
        locationCount[location] = (locationCount[location] || 0) + 1;
      });
      let maxCount = 0;
      let mostCommon = "-";
      for (const [location, count] of Object.entries(locationCount)) {
        if (count > maxCount) {
          maxCount = count;
          mostCommon = location;
        }
      }
      return mostCommon;
    }
    async function showStaffDetails(user) {
      currentStaffId = user.id;
      const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || "N/A";
      const initials = (user.firstName?.charAt(0) || '') + (user.lastName?.charAt(0) || '');
      detailsName.textContent = fullName;
      detailsRole.textContent = user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : "N/A";
      detailsStatus.textContent = (user.status || "active").charAt(0).toUpperCase() + (user.status || "active").slice(1);
      detailsStatus.className = "staff-status " + ((user.status || "active") === "active" ? "status-active" : "status-inactive");
      detailsAvatar.textContent = initials || "N/A";
      detailsFullName.textContent = fullName;
      detailsEmail.textContent = user.email || "N/A";
      detailsDepartment.textContent = user.department || "N/A";
      detailsPosition.textContent = user.jobPosition || "N/A";
      detailsPhone.textContent = user.phone || "N/A";
      detailsAddress.textContent = user.address || "N/A";
      detailsJoinDate.textContent = formatDate(user.startDate);
      detailsWorkDuration.textContent = calculateWorkDuration(user.startDate);
      const emergency = user.emergencyContact || {};
      emergencyName.textContent = emergency.name || "N/A";
      emergencyPhone.textContent = emergency.phone || "N/A";
      emergencyRelation.textContent = emergency.relation || "N/A";
      const attendanceData = allAttendance.filter(a => a.userId === user.id);
      const totalDays = attendanceData.length;
      const lateCheckins = attendanceData.filter(a => a.status === "Late").length;
      const remoteDays = attendanceData.filter(a => a.locationStatus?.includes("Far")).length;
      const onTimeRate = totalDays > 0 ? Math.round(((totalDays - lateCheckins) / totalDays) * 100) : 0;
      const avgCheckin = calculateAverageCheckin(attendanceData);
      const commonLocation = findMostCommonLocation(attendanceData);
      detailsTotalDays.textContent = totalDays;
      detailsLateCheckins.textContent = lateCheckins;
      detailsRemoteDays.textContent = remoteDays;
      detailsOnTimeRate.textContent = `${onTimeRate}%`;
      detailsAvgCheckin.textContent = avgCheckin;
      detailsCommonLocation.textContent = commonLocation;
      loadLeaveRequests(user.id);
      loadAttendanceLog(user.id);
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      document.querySelector('.tab[data-tab="profile"]').classList.add('active');
      document.getElementById('profile-tab').classList.add('active');
      staffListPage.style.display = "none";
      sidebar.style.display = "none";
      staffDetailsPage.style.display = "flex";
    }
    function loadLeaveRequests(userId) {
      const year = yearFilter.value;
      const month = monthFilter.value;
      const filteredRequests = filterLeaveRequests(userId, year, month);
      if (filteredRequests.length === 0) {
        leaveRequestsBody.innerHTML = '';
        leaveEmptyState.style.display = 'block';
        return;
      }
      leaveEmptyState.style.display = 'none';
      let html = '';
      filteredRequests.forEach(request => {
        const statusClass = request.status === 'Approved' ? 'status-active' : 
                           request.status === 'Rejected' ? 'status-inactive' : 'status-yellow';
        html += `
          <tr>
            <td>${formatDate(request.startDate)}</td>
            <td>${formatDate(request.endDate)}</td>
            <td>${request.leaveType || 'N/A'}</td>
            <td>${request.reason || 'N/A'}</td>
            <td><span class="status ${statusClass}">${request.status || 'Pending'}</span></td>
          </tr>
        `;
      });
      leaveRequestsBody.innerHTML = html;
    }
    // ✅ FIXED: Use correct field names
    function loadAttendanceLog(userId) {
      const year = logYearFilter.value;
      const month = logMonthFilter.value;
      const filteredAttendance = filterAttendance(userId, year, month);
      if (filteredAttendance.length === 0) {
        attendanceLogBody.innerHTML = '';
        logEmptyState.style.display = 'block';
        return;
      }
      logEmptyState.style.display = 'none';
      let html = '';
      filteredAttendance.forEach(record => {
        const statusClass = record.status === "On Time" ? "status-green" : "status-red";
        const locationStatus = record.locationStatus || "Unknown";
        const isAtOffice = locationStatus.includes("At Office") || locationStatus.includes("At Home");
        const locationIcon = isAtOffice ? "fa-building" : "fa-exclamation-triangle";
        const displayDate = record.timestamp ? extractDateFromTimestamp(record.timestamp) : 'N/A';
        html += `
          <tr>
            <td>${displayDate}</td>
            <td>${formatTime(record.checkin)}</td>
            <td>${formatTime(record.checkout)}</td>
            <td><span class="status ${statusClass}">${record.status || 'N/A'}</span></td>
            <td>
              <div class="location">
                <span class="location-icon">
                  <i class="fas ${locationIcon}"></i>
                </span>
                ${locationStatus}
              </div>
            </td>
          </tr>
        `;
      });
      attendanceLogBody.innerHTML = html;
    }
    async function toggleStaffStatus(userId, currentStatus) {
      try {
        const userRef = doc(db, "users", userId);
        await updateDoc(userRef, {
          status: currentStatus === "active" ? "inactive" : "active"
        });
        const userIndex = allUsers.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          allUsers[userIndex].status = currentStatus === "active" ? "inactive" : "active";
        }
        renderStaffTable();
        updateStats();
        return true;
      } catch (error) {
        console.error("Error updating staff status:", error);
        alert("Failed to update staff status. Please try again.");
        return false;
      }
    }
    async function deleteStaffAccount(userId) {
      if (!confirm("Are you sure you want to delete this staff member? This action cannot be undone.")) {
        return false;
      }
      try {
        await deleteDoc(doc(db, "users", userId));
        allUsers = allUsers.filter(u => u.id !== userId);
        renderStaffTable();
        updateStats();
        return true;
      } catch (error) {
        console.error("Error deleting staff account:", error);
        alert("Failed to delete staff account. Please try again.");
        return false;
      }
    }
    function renderStaffTable() {
      if (allUsers.length === 0) {
        staffBody.innerHTML = '';
        staffEmptyState.style.display = 'block';
        return;
      }
      staffEmptyState.style.display = 'none';
      let html = '';
      allUsers.forEach(user => {
        const status = user.status || "active";
        const statusClass = status === "active" ? "status-active" : "status-inactive";
        const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || "N/A";
        html += `
          <tr>
            <td class="clickable-name" data-id="${user.id}">${fullName}</td>
            <td>${user.email || 'N/A'}</td>
            <td>${user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : 'N/A'}</td>
            <td><span class="status ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>
            <td>
              <button class="action-btn btn-disable" data-id="${user.id}" data-status="${status}">
                ${status === "active" ? "Disable" : "Enable"}
              </button>
              <button class="action-btn btn-delete" data-id="${user.id}">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
      staffBody.innerHTML = html;
      document.querySelectorAll('.clickable-name').forEach(cell => {
        cell.addEventListener('click', (e) => {
          const userId = e.target.dataset.id;
          const user = allUsers.find(u => u.id === userId);
          if (user) showStaffDetails(user);
        });
      });
      document.querySelectorAll('.btn-disable').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const userId = e.target.dataset.id;
          const currentStatus = e.target.dataset.status;
          const success = await toggleStaffStatus(userId, currentStatus);
          if (success) {
            alert(`Staff ${currentStatus === "active" ? "disabled" : "enabled"} successfully!`);
          }
        });
      });
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const userId = e.target.dataset.id;
          const success = await deleteStaffAccount(userId);
          if (success) {
            alert("Staff member deleted successfully!");
          }
        });
      });
    }
    function updateStats() {
      const total = allUsers.length;
      const active = allUsers.filter(u => (u.status || "active") === "active").length;
      const inactive = total - active;
      totalStaffEl.textContent = total;
      activeStaffEl.textContent = active;
      inactiveStaffEl.textContent = inactive;
    }
    async function fetchAllData() {
      try {
        const usersSnapshot = await getDocs(collection(db, "users"));
        allUsers = [];
        usersSnapshot.forEach(doc => {
          allUsers.push({ id: doc.id, ...doc.data() });
        });
        // ✅ Fetch from attendance_test
        const attendanceSnapshot = await getDocs(collection(db, "attendance_test"));
        allAttendance = [];
        attendanceSnapshot.forEach(doc => {
          allAttendance.push({ id: doc.id, ...doc.data() });
        });
        const leaveSnapshot = await getDocs(collection(db, "leaveRequests"));
        allLeaveRequests = [];
        leaveSnapshot.forEach(doc => {
          allLeaveRequests.push({ id: doc.id, ...doc.data() });
        });
        populateYearFilters();
        renderStaffTable();
        updateStats();
        loadingOverlay.style.display = "none";
      } catch (error) {
        console.error("Error fetching ", error);
        loadingOverlay.innerHTML = '<p>Error loading data. Please try again.</p>';
      }
    }
    function initPage() {
      navLinks.innerHTML = "";
      if (currentUser && currentUser.role === "admin") {
              addNavLink("Dashboard", "fa-home", "/admin-dashboard");
              addNavLink("Staff Management", "fa-users", "/manage-staff", true);
              addNavLink("Staff Attendance Log", "fa-list", "/admin-attendancelog");
              addNavLink("Staff Leave Requests", "fa-calendar-alt", "/admin-leavecalendar");
              addNavLink("Staff Live Location", "fa-location-dot", "/admin-liveloc");
              addNavLink("Admin Profile", "fa-user", "/profile");
      }
      addLogout();
      fetchAllData();
    }
    function addNavLink(text, icon, link = "#", isActive = false) {
      const li = document.createElement("a");
      li.className = `nav-item ${isActive ? 'active' : ''}`;
      li.innerHTML = `<i class="fas ${icon}"></i><span>${text}</span>`;
      if (link === "#") {
        li.addEventListener("click", () => {
          document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
          li.classList.add('active');
        });
      } else {
        li.href = link;
      }
      navLinks.appendChild(li);
    }
    function addLogout() {
      const logoutDiv = document.createElement("div");
      logoutDiv.style.marginTop = "auto";
      logoutDiv.style.paddingTop = "10px";
      logoutDiv.style.borderTop = "1px solid #eee";
      const li = document.createElement("a");
      li.className = "nav-item";
      li.innerHTML = `<i class="fas fa-sign-out-alt"></i><span>Logout</span>`;
      li.addEventListener("click", async (e) => {
        e.preventDefault();
        if (confirm("Are you sure you want to log out?")) {
          try {
            await signOut(auth);
            window.location.href = "/";
          } catch (err) {
            console.error("Logout error:", err);
            alert("Failed to log out. Please try again.");
          }
        }
      });
      logoutDiv.appendChild(li);
      navLinks.appendChild(logoutDiv);
    }
    yearFilter.addEventListener('change', function() {
      if (currentStaffId) loadLeaveRequests(currentStaffId);
    });
    monthFilter.addEventListener('change', function() {
      if (currentStaffId) loadLeaveRequests(currentStaffId);
    });
    logYearFilter.addEventListener('change', function() {
      if (currentStaffId) loadAttendanceLog(currentStaffId);
    });
    logMonthFilter.addEventListener('change', function() {
      if (currentStaffId) loadAttendanceLog(currentStaffId);
    });
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const docRef = doc(db, "users", user.uid);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            currentUser = { id: user.uid, ...data };
            const firstName = data.firstName || "User";
            const initial1 = data.firstName ? data.firstName.charAt(0).toUpperCase() : "";
            const initial2 = data.lastName ? data.lastName.charAt(0).toUpperCase() : "";
            const initials = (initial1 + initial2) || "U";
            sidebarUserName.textContent = firstName;
            sidebarUserEmail.textContent = data.email || user.email;
            sidebarAvatar.textContent = initials;
            initPage();
          } else {
            console.error("User document not found");
            loadingOverlay.innerHTML = '<p>User data not found. Please log in again.</p>';
          }
        } catch (e) {
          console.error("Error loading user ", e);
          loadingOverlay.innerHTML = '<p>Error loading user data. Please try again.</p>';
        }
      } else {
        setTimeout(() => window.location.href = "/", 1000);
      }
    });
  </script>
</body>
</html>
