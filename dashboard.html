<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- ✅ ADD jsPDF HERE -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background: linear-gradient(135deg, #667eea, #764ba2);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      display: flex;
      font-size: 14px;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.95);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      box-shadow: 3px 0 15px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar-header {
      padding: 25px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: #333;
    }

    .sidebar.collapsed .logo-text {
      display: none;
    }

    .toggle-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: #667eea;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .toggle-btn:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .nav-links {
      padding: 20px 0;
      flex: 1;
    }

    .nav-item {
      padding: 12px 25px;
      display: flex;
      align-items: center;
      gap: 15px;
      text-decoration: none;
      color: #555;
      font-weight: 500;
      transition: all 0.2s;
      border-left: 4px solid transparent;
      cursor: pointer;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      border-left: 4px solid #667eea;
    }

    .nav-item i {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .sidebar.collapsed .nav-item span {
      display: none;
    }

    .sidebar.collapsed .nav-item {
      justify-content: center;
      padding: 15px;
      gap: 0;
    }

    .user-info {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
      text-transform: uppercase;
    }

    .user-details {
      flex: 1;
    }

    .user-name {
      font-weight: 600;
      color: #333;
    }

    .user-email {
      font-size: 0.85rem;
      color: #777;
    }

    .sidebar.collapsed .user-details {
      display: none;
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      flex: 1;
      padding: 30px;
      margin-left: 280px;
      transition: margin-left 0.3s ease;
    }

    .sidebar.collapsed ~ .main-content {
      margin-left: 70px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    .welcome-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .welcome-header h1 {
      font-size: 2.2rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
    }

    .welcome-header p {
      color: #666;
      font-size: 1.1rem;
    }

    /* === Warning Notifications === */
    #warningNotifications {
      background: #fff5f5;
      border-left: 4px solid #dc3545;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      display: none;
    }
    .warning-title {
      font-weight: 700;
      color: #dc3545;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .warning-item {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .warning-item:last-child {
      margin-bottom: 0;
    }
    .warning-actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .warning-btn {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .btn-download {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .btn-mark {
      background: #e9ecef;
      color: #495057;
    }

    /* Stats Cards */
    .stats-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .stat-card {
      flex: 1;
      min-width: 250px;
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 20px;
      font-size: 24px;
    }

    .leave-icon {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }

    .late-icon {
      background: rgba(220, 53, 69, 0.2);
      color: #DC3545;
    }

    .stat-info h3 {
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 8px;
    }

    .stat-info p {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
    }

    /* Sections */
    .section-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 1.5rem;
      color: #333;
      font-weight: 600;
    }

    .apply-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    .apply-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .leave-list {
      min-height: 100px;
    }

    .leave-item {
      display: flex;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid #eee;
    }

    .leave-item:last-child {
      border-bottom: none;
    }

    .leave-info {
      display: flex;
      flex-direction: column;
    }

    .leave-type {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .leave-dates {
      color: #666;
      font-size: 0.9rem;
    }

    .leave-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-pending {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }

    .status-approved {
      background: rgba(40, 167, 69, 0.2);
      color: #28A745;
    }

    .status-rejected {
      background: rgba(220, 53, 69, 0.2);
      color: #DC3545;
    }

    /* Attendance Log Section */
    .attendance-log {
      max-height: 400px;
      overflow-y: auto;
    }

    .attendance-item {
      display: flex;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid #eee;
      align-items: flex-start;
    }

    .attendance-item:last-child {
      border-bottom: none;
    }

    .attendance-info {
      flex: 1;
      margin-right: 15px;
    }

    .attendance-date {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .attendance-time {
      color: #666;
      font-size: 0.95rem;
    }

    .attendance-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-on-time {
      background: rgba(40, 167, 69, 0.2);
      color: #28A745;
    }

    .status-late {
      background: rgba(220, 53, 69, 0.2);
      color: #DC3545;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .modal-header {
      padding: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .close-modal {
      background: none;
      border: none;
      color: white;
      font-size: 1.8rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s;
    }

    .close-modal:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .form-group {
      padding: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .modal-footer {
      padding: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      border-top: 1px solid #eee;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    .btn-secondary {
      background: #eee;
      color: #333;
      border: none;
    }

    .btn-secondary:hover {
      background: #ddd;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    /* Loading Overlay */
    #loadingOverlay {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%; 
      height: 100%;
      background: rgba(102, 126, 234, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      color: #fff;
      font-size: 18px;
      backdrop-filter: blur(10px);
      font-family: 'Poppins', sans-serif;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #fff;
      border-radius: 50%;
      width: 60px; 
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
      }
      
      .sidebar .logo-text,
      .sidebar .user-details,
      .sidebar .nav-item span {
        display: none;
      }
      
      .sidebar .nav-item {
        justify-content: center;
        padding: 15px;
        gap: 0;
      }
      
      .main-content {
        margin-left: 70px;
        padding: 20px;
      }
      
      .container {
        padding: 25px;
      }
      
      .stats-container {
        flex-direction: column;
      }
      
      .stat-card {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading dashboard...</p>
  </div>

  <!-- Sidebar Navigation -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-user-clock"></i>
        </div>
        <div class="logo-text">Attendance</div>
      </div>
      <button class="toggle-btn" id="toggleSidebar">
        <i class="fas fa-chevron-left"></i>
      </button>
    </div>
    
    <div class="nav-links" id="navLinks">
      <!-- Navigation will be populated by JavaScript -->
    </div>
    
    <div class="user-info" id="userInfo">
      <div class="avatar" id="sidebarAvatar">U</div>
      <div class="user-details">
        <div class="user-name" id="sidebarUserName">Loading...</div>
        <div class="user-email" id="sidebarUserEmail">Loading...</div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="container">
      <!-- Warning Notifications -->
      <div id="warningNotifications">
        <div class="warning-title"><i class="fas fa-exclamation-triangle"></i> Important Notices</div>
        <div id="warningList"></div>
      </div>

      <div class="welcome-header">
        <h1 id="welcomeText">Welcome!</h1>
        <p>Here's an overview of your attendance and leave requests</p>
      </div>
      
      <!-- Stats Cards -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon leave-icon">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-info">
            <h3>Pending Leaves</h3>
            <p id="totalLeaveRequests">0</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon late-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-info">
            <h3>Late Arrivals</h3>
            <p id="lateCount">0</p>
          </div>
        </div>
      </div>
      
      <!-- My Leave Requests -->
      <div class="section-card">
        <div class="section-header">
          <h3 class="section-title">My Leave Requests</h3>
          <button class="apply-btn" id="applyLeaveBtn">
            <i class="fas fa-plus"></i> Apply
          </button>
        </div>
        <div class="leave-list" id="myLeaveList">
          <p style="text-align:center; color:#666; padding:20px;">No leave requests found</p>
        </div>
      </div>
      
      <!-- Attendance Log -->
      <div class="section-card">
        <div class="section-header">
          <h3 class="section-title">Attendance Log</h3>
        </div>
        <div class="attendance-log" id="attendanceLog">
          <p style="text-align:center; color:#666; padding:20px;">No attendance records found</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Apply Leave Modal -->
  <div class="modal" id="applyLeaveModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Apply for Leave</h3>
        <button class="close-modal" id="closeModal">&times;</button>
      </div>
      <form id="leaveForm">
        <div class="form-group">
          <label for="leaveType">Leave Type</label>
          <select id="leaveType" required>
            <option value="">Select leave type</option>
            <option value="annual">Annual Leave</option>
            <option value="sick">Sick Leave</option>
            <option value="personal">Personal Leave</option>
            <option value="maternity">Maternity Leave</option>
            <option value="paternity">Paternity Leave</option>
          </select>
        </div>
        <div class="form-group">
          <label for="startDate">Start Date</label>
          <input type="date" id="startDate" required>
        </div>
        <div class="form-group">
          <label for="endDate">End Date</label>
          <input type="date" id="endDate" required>
        </div>
        <div class="form-group">
          <label for="reason">Reason</label>
          <textarea id="reason" rows="4" placeholder="Please provide a reason for your leave request"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="cancelLeave">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit Request</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      query, 
      where, 
      onSnapshot, 
      doc, 
      getDoc,
      getDocs,
      updateDoc,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB3nU-WVQ-7zm9RijUhj420QPET9GYQpj8",
      authDomain: "login-form-84016.firebaseapp.com",
      projectId: "login-form-84016",
      storageBucket: "login-form-84016.firebasestorage.app",
      messagingSenderId: "568483509830",
      appId: "1:568483509830:web:0d6de2a1537154bd67fc47",
      measurementId: "G-KCGTMGB6HB"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // Global state
    let currentUid = null;
    let currentUserData = null;

    // DOM Elements
    const myLeaveList = document.getElementById('myLeaveList');
    const applyLeaveBtn = document.getElementById('applyLeaveBtn');
    const applyLeaveModal = document.getElementById('applyLeaveModal');
    const closeModal = document.getElementById('closeModal');
    const cancelLeave = document.getElementById('cancelLeave');
    const leaveForm = document.getElementById('leaveForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const sidebarAvatar = document.getElementById("sidebarAvatar");
    const sidebarUserName = document.getElementById("sidebarUserName");
    const sidebarUserEmail = document.getElementById("sidebarUserEmail");
    const welcomeText = document.getElementById("welcomeText");
    const totalLeaveRequests = document.getElementById("totalLeaveRequests");
    const lateCount = document.getElementById("lateCount");
    const navLinks = document.getElementById("navLinks");
    const attendanceLog = document.getElementById("attendanceLog");

    // === NEW: Warning Elements ===
    const warningNotifications = document.getElementById("warningNotifications");
    const warningList = document.getElementById("warningList");

    // Add navigation link function (matches Attendance Management style)
    function addNavLink(text, icon, link, isActive = false) {
      const a = document.createElement("a");
      a.className = `nav-item ${isActive ? 'active' : ''}`;
      a.href = link;
      a.innerHTML = `<i class="fas ${icon}"></i><span>${text}</span>`;
      navLinks.appendChild(a);
    }

    // Add logout function (matches style: at bottom, with confirm)
    function addLogout() {
      const wrap = document.createElement("div");
      wrap.style.marginTop = "auto";
      wrap.style.paddingTop = "10px";
      wrap.style.borderTop = "1px solid #eee";
      const a = document.createElement("a");
      a.className = "nav-item";
      a.innerHTML = `<i class="fas fa-sign-out-alt"></i><span>Logout</span>`;
      a.addEventListener("click", async (e) => {
        e.preventDefault();
        if (confirm("Are you sure you want to log out?")) {
          await signOut(auth);
          window.location.href = "/";
        }
      });
      wrap.appendChild(a);
      navLinks.appendChild(wrap);
    }

    // Build navigation based on user role (exactly like Attendance Management)
    function buildNavigation(role) {
      navLinks.innerHTML = "";
      if (role === "admin") {
        addNavLink("Dashboard", "fa-home", "/dashboard", true);
        addNavLink("Staff Management", "fa-users", "/manage-staff");
        addNavLink("Staff Attendance Log", "fa-list", "/admin-attendancelog");
        addNavLink("Staff Leave Requests", "fa-calendar-alt", "/admin-leavecalendar");
        addNavLink("Admin Profile", "fa-user", "/profile");
      } else {
        addNavLink("Dashboard", "fa-home", "/dashboard", true);
        addNavLink("Attendance Log", "fa-list", "/attendance");
        addNavLink("Leave Requests", "fa-calendar-alt", "/leavecalendar");
        addNavLink("Profile", "fa-user", "/profile");
      }
      addLogout();
    }

    // Get today's date in YYYY-MM-DD format
    function getTodayDate() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    // Format date for display
    function formatDate(dateStr) {
      if (!dateStr) return "N/A";
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateStr).toLocaleDateString('en-US', options);
    }

    // Handle checkout action
    async function handleCheckout(docId) {
      if (!docId) {
        alert("Error: No attendance record found.");
        return;
      }

      showLoading();
      try {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

        await updateDoc(doc(db, "attendance_test", docId), {
          checkout: timeString,
          lastUpdated: now
        });

        alert("✅ Checked out successfully!");
      } catch (error) {
        console.error("Checkout error:", error);
        alert("❌ Failed to check out. Please try again.");
      } finally {
        hideLoading();
      }
    }

    // Load Warning Letters
    async function loadWarningLetters() {
      if (!currentUid) return;
      try {
        const q = query(
          collection(db, "warningLetters"),
          where("staffId", "==", currentUid),
          where("status", "==", "unread")
        );
        const snapshot = await getDocs(q);
        const warnings = [];
        snapshot.forEach(doc => warnings.push({ id: doc.id, ...doc.data() }));
        
        if (warnings.length > 0) {
          warningList.innerHTML = '';
          warnings.forEach(w => {
            const div = document.createElement("div");
            div.className = "warning-item";
            const sentDate = new Date(w.sentAt).toLocaleString();
            div.innerHTML = `
              <div><strong>⚠️ Attendance Warning</strong></div>
              <p><small>${w.reason || "Excessive late arrivals."}</small></p>
              <p><em>Sent on: ${sentDate}</em></p>
              <div class="warning-actions">
                <button class="warning-btn btn-download" onclick="downloadWarningLetter('${w.id}', '${w.reason || "Excessive late arrivals."}')">
                  <i class="fas fa-download"></i> Download Letter
                </button>
                <button class="warning-btn btn-mark" onclick="markWarningAsRead('${w.id}')">
                  Mark as Read
                </button>
              </div>
            `;
            warningList.appendChild(div);
          });
          warningNotifications.style.display = 'block';
        } else {
          warningNotifications.style.display = 'none';
        }
      } catch (err) {
        console.error("Error loading warnings:", err);
      }
    }

    // Mark as Read
    window.markWarningAsRead = async function(letterId) {
      try {
        await updateDoc(doc(db, "warningLetters", letterId), { status: "read" });
        loadWarningLetters();
      } catch (err) {
        console.error("Failed to mark as read:", err);
        alert("Failed to update warning status.");
      }
    };

    // Download as PDF
    window.downloadWarningLetter = function(letterId, reason) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const staffName = sidebarUserName.textContent.trim() || "Staff Member";
      const dateStr = new Date().toLocaleDateString();

      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("ATTENDANCE WARNING LETTER", 15, 20);

      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      const lines = [
        "",
        "To: " + staffName,
        "From: Human Resources / Admin",
        "Date: " + dateStr,
        "",
        "This is to formally notify you that our attendance records indicate",
        "you have violated company punctuality policy.",
        "",
        "Reason: " + reason,
        "",
        "Repeated tardiness affects team productivity and is a breach of employment terms.",
        "",
        "You are hereby warned to maintain punctuality effective immediately.",
        "",
        "Failure to comply may result in further disciplinary action,",
        "up to and including termination.",
        "",
        "Sincerely,",
        "Management",
        "Company: Setapak Central"
      ];

      doc.text(lines, 15, 30);
      doc.save(`warning_letter_${new Date().toISOString().slice(0, 10)}.pdf`);
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      showLoading();
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').min = today;
      document.getElementById('endDate').min = today;
      
      applyLeaveBtn.addEventListener('click', () => {
        applyLeaveModal.style.display = 'flex';
      });
      
      closeModal.addEventListener('click', () => {
        applyLeaveModal.style.display = 'none';
      });
      
      cancelLeave.addEventListener('click', () => {
        applyLeaveModal.style.display = 'none';
      });
      
      leaveForm.addEventListener('submit', (e) => {
        e.preventDefault();
        submitLeaveRequest();
      });
      
      window.addEventListener('click', (e) => {
        if (e.target === applyLeaveModal) {
          applyLeaveModal.style.display = 'none';
        }
      });
      
      document.getElementById('toggleSidebar').addEventListener("click", () => {
        const sidebar = document.querySelector(".sidebar");
        sidebar.classList.toggle("collapsed");
        const icon = document.getElementById('toggleSidebar').querySelector("i");
        icon.className = sidebar.classList.contains("collapsed") 
          ? "fas fa-chevron-right" 
          : "fas fa-chevron-left";
      });
    });

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUid = user.uid;
        try {
          const userDoc = await getDoc(doc(db, "users", currentUid));
          if (userDoc.exists()) {
            currentUserData = userDoc.data();
            updateSidebarUI(currentUserData);
            buildNavigation(currentUserData.role || "staff");
          }
        } catch (err) {
          console.error("Error fetching user:", err);
        }
        
        setupLeaveListeners();
        setupAttendanceListener();
        loadWarningLetters();
        hideLoading();
      } else {
        hideLoading();
        window.location.href = "/";
      }
    });

    // Update sidebar with user data
    function updateSidebarUI(userData) {
      const firstName = userData.firstName || "";
      const lastName = userData.lastName || "";
      const email = userData.email || "";

      const initial1 = firstName.charAt(0).toUpperCase() || "";
      const initial2 = lastName.charAt(0).toUpperCase() || "";
      const initials = (initial1 + initial2) || "U";

      sidebarUserName.textContent = firstName;
      sidebarUserEmail.textContent = email || "No email";
      sidebarAvatar.textContent = initials;
      welcomeText.textContent = `Welcome, ${firstName}!`;
    }

    // Setup real-time listeners for leave requests
    function setupLeaveListeners() {
      if (!currentUid) return;
      
      const myLeaveQuery = query(
        collection(db, "leaveRequests"), 
        where("userId", "==", currentUid),
        where("status", "==", "pending")
      );
      
      onSnapshot(myLeaveQuery, (snapshot) => {
        totalLeaveRequests.textContent = snapshot.size;
      });
      
      const allLeavesQuery = query(
        collection(db, "leaveRequests"), 
        where("userId", "==", currentUid)
      );
      
      onSnapshot(allLeavesQuery, (snapshot) => {
        const allLeaves = [];
        snapshot.forEach(doc => {
          allLeaves.push({ id: doc.id, ...doc.data() });
        });
        renderMyLeaveRequests(allLeaves);
      });
    }

    // Fetch from 'attendance_test' collection
    function setupAttendanceListener() {
      if (!currentUid) return;
      
      const attendanceQuery = query(
        collection(db, "attendance_test"),
        where("userId", "==", currentUid),
        orderBy("timestamp", "desc")
      );
      
      onSnapshot(attendanceQuery, (snapshot) => {
        let lateCountValue = 0;
        const records = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          records.push({ id: doc.id, ...data });
          if (data.status === "Late") {
            lateCountValue++;
          }
        });
        lateCount.textContent = lateCountValue;
        renderAttendanceLog(records.slice(0, 5));
      });
    }

    // Render user's leave requests
    function renderMyLeaveRequests(leaves) {
      myLeaveList.innerHTML = '';
      if (leaves.length === 0) {
        myLeaveList.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No leave requests found</p>';
        return;
      }
      
      leaves.forEach(leave => {
        const leaveItem = document.createElement('div');
        leaveItem.className = 'leave-item';
        const startDate = formatDate(leave.startDate);
        const endDate = formatDate(leave.endDate);
        const status = (leave.status || 'pending').toLowerCase();
        const statusDisplay = (leave.status || 'Pending').charAt(0).toUpperCase() + (leave.status || 'pending').slice(1);
        
        leaveItem.innerHTML = `
          <div class="leave-info">
            <div class="leave-type">${leave.leaveType}</div>
            <div class="leave-dates">${startDate} - ${endDate}</div>
          </div>
          <div class="leave-status status-${status}">${statusDisplay}</div>
        `;
        myLeaveList.appendChild(leaveItem);
      });
    }

    // Render attendance log
    function renderAttendanceLog(records) {
      attendanceLog.innerHTML = '';
      if (records.length === 0) {
        attendanceLog.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No attendance records found</p>';
        return;
      }

      const
