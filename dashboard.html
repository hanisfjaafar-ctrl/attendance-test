<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard - Optimized</title>

  <!-- Fonts & icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* (kept same CSS as original but trimmed comments) */
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
    body{background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:0;overflow-x:hidden;display:flex}
    .sidebar{width:280px;background:rgba(255,255,255,.95);height:100vh;position:fixed;top:0;left:0;z-index:1000;box-shadow:3px 0 15px rgba(0,0,0,.15);transition:all .3s ease;display:flex;flex-direction:column;backdrop-filter:blur(10px)}
    .sidebar.collapsed{width:70px}
    .sidebar-header{padding:25px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px}
    .logo-text{font-size:1.5rem;font-weight:700;color:#333}
    .sidebar.collapsed .logo-text{display:none}
    .toggle-btn{background:none;border:none;font-size:1.2rem;cursor:pointer;color:#667eea;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .3s}
    .toggle-btn:hover{background:rgba(102,126,234,.1)}
    .nav-links{padding:20px 0;flex:1}
    .nav-item{padding:12px 25px;display:flex;align-items:center;gap:15px;text-decoration:none;color:#555;font-weight:500;transition:all .2s;border-left:4px solid transparent;cursor:pointer}
    .nav-item:hover,.nav-item.active{background:rgba(102,126,234,.1);color:#667eea;border-left:4px solid #667eea}
    .nav-item i{font-size:1.2rem;width:24px;text-align:center}
    .sidebar.collapsed .nav-item span{display:none}
    .sidebar.collapsed .nav-item{justify-content:center;padding:15px;gap:0}
    .user-info{padding:20px;border-top:1px solid #eee;display:flex;align-items:center;gap:15px}
    .avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px;text-transform:uppercase}
    .user-details{flex:1}
    .user-name{font-weight:600;color:#333}
    .user-email{font-size:.85rem;color:#777}
    .sidebar.collapsed .user-details{display:none}
    .main-content{flex:1;padding:30px;margin-left:280px;transition:margin-left .3s ease}
    .sidebar.collapsed ~ .main-content{margin-left:70px}
    .container{max-width:1200px;margin:0 auto;background:#fff;padding:40px;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);backdrop-filter:blur(10px)}
    .welcome-header{text-align:center;margin-bottom:30px}
    .welcome-header h1{font-size:2.2rem;font-weight:700;color:#333;margin-bottom:10px}
    .welcome-header p{color:#666;font-size:1.1rem}
    #warningNotifications{background:#fff5f5;border-left:4px solid #dc3545;padding:20px;border-radius:12px;margin-bottom:25px;display:none}
    .warning-title{font-weight:700;color:#dc3545;margin-bottom:12px;display:flex;align-items:center;gap:8px}
    .warning-item{background:white;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .warning-actions{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    .warning-btn{padding:6px 14px;border-radius:6px;font-size:.9rem;font-weight:600;cursor:pointer;border:none}
    .btn-download{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
    .btn-mark{background:#e9ecef;color:#495057}
    .stats-container{display:flex;gap:20px;margin-bottom:30px;flex-wrap:wrap}
    .stat-card{flex:1;min-width:250px;background:white;border-radius:15px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.1);display:flex;align-items:center;transition:transform .3s}
    .stat-card:hover{transform:translateY(-5px)}
    .stat-icon{width:60px;height:60px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-right:20px;font-size:24px}
    .leave-icon{background:rgba(255,193,7,.2);color:#FFC107}
    .late-icon{background:rgba(220,53,69,.2);color:#DC3545}
    .stat-info h3{font-size:1.1rem;color:#555;margin-bottom:8px}
    .stat-info p{font-size:2rem;font-weight:700;color:#333}
    .section-card{background:white;border-radius:15px;padding:25px;margin-bottom:30px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .section-title{font-size:1.5rem;color:#333;font-weight:600}
    .apply-btn{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;transition:all .3s}
    .apply-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    .leave-list{min-height:100px}
    .leave-item{display:flex;justify-content:space-between;padding:15px 0;border-bottom:1px solid #eee}
    .leave-item:last-child{border-bottom:none}
    .leave-info{display:flex;flex-direction:column}
    .leave-type{font-weight:600;color:#333;margin-bottom:5px}
    .leave-dates{color:#666;font-size:.9rem}
    .leave-status{padding:5px 12px;border-radius:20px;font-size:.85rem;font-weight:600}
    .status-pending{background:rgba(255,193,7,.2);color:#FFC107}
    .status-approved{background:rgba(40,167,69,.2);color:#28A745}
    .status-rejected{background:rgba(220,53,69,.2);color:#DC3545}
    .attendance-log{max-height:400px;overflow-y:auto}
    .attendance-item{display:flex;justify-content:space-between;padding:15px 0;border-bottom:1px solid #eee;align-items:flex-start}
    .attendance-item:last-child{border-bottom:none}
    .attendance-info{flex:1;margin-right:15px}
    .attendance-date{font-weight:600;color:#333;margin-bottom:4px}
    .attendance-time{color:#666;font-size:.95rem}
    .attendance-status{padding:4px 10px;border-radius:20px;font-size:.8rem;font-weight:600;white-space:nowrap}
    .status-on-time{background:rgba(40,167,69,.2);color:#28A745}
    .status-late{background:rgba(220,53,69,.2);color:#DC3545}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2000;justify-content:center;align-items:center}
    .modal-content{background:white;border-radius:15px;width:90%;max-width:500px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden}
    .modal-header{padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-size:1.5rem;font-weight:600}
    .close-modal{background:none;border:none;color:white;font-size:1.8rem;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .3s}
    .close-modal:hover{background:rgba(255,255,255,.2)}
    .form-group{padding:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#333}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:1rem}
    .form-group textarea{resize:vertical;min-height:100px}
    .modal-footer{padding:20px;display:flex;justify-content:flex-end;gap:15px;border-top:1px solid #eee}
    .btn{padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:all .3s}
    .btn-secondary{background:#eee;color:#333;border:none}
    .btn-secondary:hover{background:#ddd}
    .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.4)}
    #loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(102,126,234,.95);display:flex;justify-content:center;align-items:center;flex-direction:column;z-index:9999;color:#fff;font-size:18px;backdrop-filter:blur(10px)}
    .spinner{border:4px solid rgba(255,255,255,.3);border-top:4px solid #fff;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin-bottom:20px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    @media (max-width:768px){.sidebar{width:70px}.sidebar .logo-text,.sidebar .user-details,.sidebar .nav-item span{display:none}.sidebar .nav-item{justify-content:center;padding:15px;gap:0}.main-content{margin-left:70px;padding:20px}.container{padding:25px}.stats-container{flex-direction:column}.stat-card{min-width:100%}}
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay"><div class="spinner"></div><p id="loadingText">Loading dashboard...</p></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-user-clock"></i></div>
        <div class="logo-text">Attendance</div>
      </div>
      <button class="toggle-btn" id="toggleSidebar" aria-label="Toggle sidebar"><i class="fas fa-chevron-left"></i></button>
    </div>
    <div class="nav-links" id="navLinks"></div>
    <div class="user-info" id="userInfo">
      <div class="avatar" id="sidebarAvatar">U</div>
      <div class="user-details">
        <div class="user-name" id="sidebarUserName">Loading...</div>
        <div class="user-email" id="sidebarUserEmail">Loading...</div>
      </div>
    </div>
  </nav>

  <!-- Main content -->
  <main class="main-content" role="main">
    <div class="container">
      <div id="warningNotifications">
        <div class="warning-title"><i class="fas fa-exclamation-triangle"></i> Important Notices</div>
        <div id="warningList"></div>
      </div>

      <div class="welcome-header">
        <h1 id="welcomeText">Welcome!</h1>
        <p>Here's an overview of your attendance and leave requests</p>
      </div>

      <div class="stats-container" aria-live="polite">
        <div class="stat-card">
          <div class="stat-icon leave-icon"><i class="fas fa-calendar-check"></i></div>
          <div class="stat-info"><h3>Pending Leaves</h3><p id="totalLeaveRequests">0</p></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon late-icon"><i class="fas fa-clock"></i></div>
          <div class="stat-info"><h3>Late Arrivals</h3><p id="lateCount">0</p></div>
        </div>
      </div>

      <section class="section-card" aria-labelledby="myLeaveTitle">
        <div class="section-header">
          <h3 id="myLeaveTitle" class="section-title">My Leave Requests</h3>
          <button class="apply-btn" id="applyLeaveBtn"><i class="fas fa-plus"></i> Apply</button>
        </div>
        <div class="leave-list" id="myLeaveList"><p style="text-align:center;color:#666;padding:20px">No leave requests found</p></div>
      </section>

      <section class="section-card" aria-labelledby="attendanceTitle">
        <div class="section-header"><h3 id="attendanceTitle" class="section-title">Attendance Log</h3></div>
        <div class="attendance-log" id="attendanceLog"><p style="text-align:center;color:#666;padding:20px">No attendance records found</p></div>
      </section>
    </div>
  </main>

  <!-- Apply Leave Modal -->
  <div class="modal" id="applyLeaveModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content" role="document">
      <div class="modal-header"><h3 class="modal-title">Apply for Leave</h3><button class="close-modal" id="closeModal" aria-label="Close">&times;</button></div>
      <form id="leaveForm" class="leave-form" novalidate>
        <div class="form-group">
          <label for="leaveType">Leave Type</label>
          <select id="leaveType" required>
            <option value="">Select leave type</option>
            <option value="annual">Annual Leave</option>
            <option value="sick">Sick Leave</option>
            <option value="personal">Personal Leave</option>
            <option value="maternity">Maternity Leave</option>
            <option value="paternity">Paternity Leave</option>
          </select>
        </div>
        <div class="form-group"><label for="startDate">Start Date</label><input id="startDate" type="date" required></div>
        <div class="form-group"><label for="endDate">End Date</label><input id="endDate" type="date" required></div>
        <div class="form-group"><label for="reason">Reason</label><textarea id="reason" rows="4" placeholder="Please provide a reason"></textarea></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" id="cancelLeave">Cancel</button><button type="submit" class="btn btn-primary">Submit Request</button></div>
      </form>
    </div>
  </div>

  <!-- Firebase + App JS (modular, optimized) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import {
      getFirestore, collection, query, where, onSnapshot, doc, getDoc, getDocs, addDoc, updateDoc, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    /* ---------------------------
       CONFIG & INITIALIZATION
       --------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB3nU-WVQ-7zm9RijUhj420QPET9GYQpj8",
      authDomain: "login-form-84016.firebaseapp.com",
      projectId: "login-form-84016",
      storageBucket: "login-form-84016.firebasestorage.app",
      messagingSenderId: "568483509830",
      appId: "1:568483509830:web:0d6de2a1537154bd67fc47",
      measurementId: "G-KCGTMGB6HB"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ---------------------------
       DOM REFS
       --------------------------- */
    const refs = {
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      sidebar: document.getElementById('sidebar'),
      toggleSidebar: document.getElementById('toggleSidebar'),
      navLinks: document.getElementById('navLinks'),
      sidebarAvatar: document.getElementById('sidebarAvatar'),
      sidebarUserName: document.getElementById('sidebarUserName'),
      sidebarUserEmail: document.getElementById('sidebarUserEmail'),
      welcomeText: document.getElementById('welcomeText'),
      totalLeaveRequests: document.getElementById('totalLeaveRequests'),
      lateCount: document.getElementById('lateCount'),
      myLeaveList: document.getElementById('myLeaveList'),
      attendanceLog: document.getElementById('attendanceLog'),
      applyLeaveBtn: document.getElementById('applyLeaveBtn'),
      applyLeaveModal: document.getElementById('applyLeaveModal'),
      closeModal: document.getElementById('closeModal'),
      cancelLeave: document.getElementById('cancelLeave'),
      leaveForm: document.getElementById('leaveForm'),
      startDate: document.getElementById('startDate'),
      endDate: document.getElementById('endDate'),
      warningNotifications: document.getElementById('warningNotifications'),
      warningList: document.getElementById('warningList')
    };

    /* ---------------------------
       UTILITIES
       --------------------------- */
    const ui = {
      showLoading(msg = 'Loading dashboard...') {
        refs.loadingText.textContent = msg;
        refs.loadingOverlay.style.display = 'flex';
      },
      hideLoading() { refs.loadingOverlay.style.display = 'none'; },
      safeText(s) { return (s || '').toString(); },
      el(tag, opts = {}, children = []) {
        const el = document.createElement(tag);
        Object.entries(opts).forEach(([k, v]) => {
          if (k === 'class') el.className = v;
          else if (k === 'html') el.innerHTML = v;
          else if (k === 'text') el.textContent = v;
          else el.setAttribute(k, v);
        });
        children.forEach(c => el.appendChild(c));
        return el;
      }
    };

    /* ---------------------------
       AUTH & APP STATE
       --------------------------- */
    let currentUid = null;
    let currentUserData = null;
    let unsubscribeLeave = null;
    let unsubscribeAttendance = null;

    function cleanupListeners() {
      if (typeof unsubscribeLeave === 'function') unsubscribeLeave();
      if (typeof unsubscribeAttendance === 'function') unsubscribeAttendance();
      unsubscribeLeave = null;
      unsubscribeAttendance = null;
    }

    /* ---------------------------
       NAV / SIDEBAR HELPERS
       --------------------------- */
    function clearNav() { refs.navLinks.innerHTML = ''; }
    function addNavLink(text, icon, href = '#', isActive = false) {
      const a = ui.el('a', { class: `nav-item ${isActive ? 'active' : ''}`, href, role: 'link' });
      a.innerHTML = `<i class="fas ${icon}"></i><span>${text}</span>`;
      refs.navLinks.appendChild(a);
      return a;
    }
    function addLogoutLink() {
      const a = ui.el('a', { class: 'nav-item logout', href: '#', id: 'logoutLink' });
      a.innerHTML = `<i class="fas fa-sign-out-alt"></i><span>Logout</span>`;
      a.addEventListener('click', async (e) => {
        e.preventDefault(); try { await signOut(auth); window.location.href = '/'; } catch (err) { console.error('Logout error', err); alert('Logout failed'); }
      });
      refs.navLinks.appendChild(a);
    }
    function buildNavigation(role = 'staff') {
      clearNav();
      if (role === 'admin') {
        addNavLink('Dashboard', 'fa-home', '/dashboard', true);
        addNavLink('Staff Management', 'fa-users', '/manage-staff');
        addNavLink('Staff Attendance Log', 'fa-list', '/admin-attendancelog');
        addNavLink('Staff Leave Requests', 'fa-calendar-alt', '/admin-leavecalendar');
        addNavLink('Admin Profile', 'fa-user', '/profile');
      } else {
        addNavLink('Dashboard', 'fa-home', '/dashboard', true);
        addNavLink('Attendance Log', 'fa-list', '/attendance');
        addNavLink('Leave Requests', 'fa-calendar-alt', '/leavecalendar');
        addNavLink('Profile', 'fa-user', '/profile');
      }
      addLogoutLink();
    }

    /* ---------------------------
       FIRESTORE: Warnings (optimized)
       --------------------------- */
    async function loadWarningLettersOnce() {
      if (!currentUid) return;
      try {
        const q = query(collection(db, 'warningLetters'), where('staffId', '==', currentUid), where('status', '==', 'unread'), limit(20));
        const snap = await getDocs(q);
        const warnings = [];
        snap.forEach(d => warnings.push({ id: d.id, ...d.data() }));
        renderWarningLetters(warnings);
      } catch (err) {
        console.error('loadWarningLettersOnce error', err);
      }
    }

    function renderWarningLetters(warnings) {
      refs.warningList.innerHTML = '';
      if (!warnings || warnings.length === 0) { refs.warningNotifications.style.display = 'none'; return; }
      const frag = document.createDocumentFragment();
      warnings.forEach(w => {
        const sentDate = w.sentAt ? new Date(w.sentAt).toLocaleString() : 'Unknown';
        const container = ui.el('div', { class: 'warning-item' });
        container.innerHTML = `
          <div><strong>⚠️ Attendance Warning</strong></div>
          <p><small>${ui.safeText(w.reason || 'Excessive late arrivals.')}</small></p>
          <p><em>Sent on: ${sentDate}</em></p>
        `;
        const actions = ui.el('div', { class: 'warning-actions' });
        const downloadBtn = ui.el('button', { class: 'warning-btn btn-download', type: 'button' });
        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Letter';
        downloadBtn.addEventListener('click', () => downloadWarningLetter(w.id, w.reason || 'Excessive late arrivals.'));
        const markBtn = ui.el('button', { class: 'warning-btn btn-mark', type: 'button' });
        markBtn.textContent = 'Mark as Read';
        markBtn.addEventListener('click', async () => { await markWarningAsRead(w.id); });
        actions.appendChild(downloadBtn); actions.appendChild(markBtn);
        container.appendChild(actions);
        frag.appendChild(container);
      });
      refs.warningList.appendChild(frag);
      refs.warningNotifications.style.display = 'block';
    }

    async function markWarningAsRead(letterId) {
      try {
        await updateDoc(doc(db, 'warningLetters', letterId), { status: 'read' });
        await loadWarningLettersOnce();
      } catch (err) {
        console.error('markWarningAsRead', err);
        alert('Failed to mark warning as read.');
      }
    }

    /* ---------------------------
       PDF (jsPDF)
       --------------------------- */
    function downloadWarningLetter(letterId, reason) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const staffName = refs.sidebarUserName.textContent.trim() || 'Staff Member';
        const dateStr = new Date().toLocaleDateString();
        doc.setFont('helvetica', 'bold'); doc.setFontSize(16);
        doc.text('ATTENDANCE WARNING LETTER', 15, 20);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(12);
        const lines = [
          '',
          `To: ${staffName}`,
          'From: Human Resources / Admin',
          `Date: ${dateStr}`,
          '',
          'This is to formally notify you that our attendance records indicate',
          'you have violated company punctuality policy.',
          '',
          `Reason: ${reason}`,
          '',
          'Repeated tardiness affects team productivity and is a breach of employment terms.',
          '',
          'You are hereby warned to maintain punctuality effective immediately.',
          '',
          'Failure to comply may result in further disciplinary action, up to and including termination.',
          '',
          'Sincerely,',
          'Management',
          'Company: Setapak Central'
        ];
        doc.text(lines, 15, 30);
        doc.save(`warning_letter_${new Date().toISOString().slice(0,10)}.pdf`);
      } catch (err) {
        console.error('downloadWarningLetter', err);
        alert('Failed to generate PDF.');
      }
    }
    window.downloadWarningLetter = downloadWarningLetter; // keep global for buttons created elsewhere

    /* ---------------------------
       LEAVE LISTENERS (realtime optimized)
       --------------------------- */
    function setupLeaveListenersRealtime() {
      if (!currentUid) return;
      // pending count
      const pendingQ = query(collection(db, 'leaveRequests'), where('userId', '==', currentUid), where('status', '==', 'pending'));
      unsubscribeLeave = onSnapshot(pendingQ, snap => {
        refs.totalLeaveRequests.textContent = snap.size;
      }, err => console.error('pendingQ snapshot error', err));

      // all leaves for rendering (limit to last 50 to avoid huge lists)
      const allQ = query(collection(db, 'leaveRequests'), where('userId', '==', currentUid), orderBy('createdAt','desc'), limit(50));
      // Use getDocs once then onSnapshot for changes if you want live updates; here we do onSnapshot
      onSnapshot(allQ, snap => {
        const leaves = [];
        snap.forEach(d => leaves.push({ id: d.id, ...d.data() }));
        renderMyLeaveRequests(leaves);
      }, err => console.error('allQ snapshot', err));
    }

    function renderMyLeaveRequests(leaves) {
      const frag = document.createDocumentFragment();
      if (!leaves || leaves.length === 0) {
        refs.myLeaveList.innerHTML = '<p style="text-align:center;color:#666;padding:20px">No leave requests found</p>';
        return;
      }
      refs.myLeaveList.innerHTML = '';
      leaves.forEach(leave => {
        const startDate = formatDate(leave.startDate);
        const endDate = formatDate(leave.endDate);
        const status = (leave.status || 'pending').toLowerCase();
        const statusDisplay = (leave.status || 'Pending').charAt(0).toUpperCase() + (leave.status || 'pending').slice(1);
        const item = ui.el('div', { class: 'leave-item' });
        item.innerHTML = `
          <div class="leave-info">
            <div class="leave-type">${ui.safeText(leave.leaveType)}</div>
            <div class="leave-dates">${startDate} - ${endDate}</div>
          </div>
          <div class="leave-status status-${status}">${ui.safeText(statusDisplay)}</div>
        `;
        frag.appendChild(item);
      });
      refs.myLeaveList.appendChild(frag);
    }

    /* ---------------------------
       ATTENDANCE (realtime optimized)
       --------------------------- */
    function setupAttendanceListenerRealtime() {
      if (!currentUid) return;
      cleanupAttendanceListener();
      const attendanceQ = query(collection(db, 'attendance_test'), where('userId', '==', currentUid), orderBy('timestamp','desc'), limit(50));
      unsubscribeAttendance = onSnapshot(attendanceQ, snap => {
        const records = [];
        let lateCountValue = 0;
        snap.forEach(d => {
          const data = d.data();
          records.push({ id: d.id, ...data });
          if (data.status === 'Late') lateCountValue++;
        });
        refs.lateCount.textContent = lateCountValue;
        renderAttendanceLog(records.slice(0, 5)); // render latest 5
      }, err => console.error('attendance snapshot', err));
    }

    function cleanupAttendanceListener() {
      if (typeof unsubscribeAttendance === 'function') unsubscribeAttendance();
      unsubscribeAttendance = null;
    }

    function renderAttendanceLog(records) {
      if (!records || records.length === 0) {
        refs.attendanceLog.innerHTML = '<p style="text-align:center;color:#666;padding:20px">No attendance records found</p>';
        return;
      }
      refs.attendanceLog.innerHTML = '';
      const frag = document.createDocumentFragment();
      const today = new Date().toISOString().split('T')[0];
      records.forEach(record => {
        if (!record || !record.id || !record.timestamp) return;
        const recordDate = new Date(record.timestamp);
        const dateStr = recordDate.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
        const timeStr = recordDate.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
        const isToday = recordDate.toISOString().split('T')[0] === today;
        const statusClass = record.status === 'On Time' ? 'on-time' : 'late';
        const checkoutButtonHTML = (isToday && !record.checkout) ? `<button class="apply-btn checkout-btn" data-id="${record.id}" style="margin-top:10px;padding:8px 16px;font-size:.95rem"><i class="fas fa-sign-out-alt"></i> Check Out</button>` : '';
        const item = ui.el('div', { class: 'attendance-item' });
        item.innerHTML = `
          <div class="attendance-info">
            <div class="attendance-date">${dateStr} ${isToday ? '<span style="color:#667eea;font-size:.9em;margin-left:6px">(Today)</span>' : ''}</div>
            <div class="attendance-time">Check-in: ${timeStr}</div>
            ${record.checkout ? `<div class="attendance-time">Check-out: ${ui.safeText(record.checkout)}</div>` : ''}
            ${checkoutButtonHTML}
          </div>
          <div class="attendance-status status-${statusClass}">${ui.safeText(record.status || 'N/A')}</div>
        `;
        frag.appendChild(item);
      });
      refs.attendanceLog.appendChild(frag);

      // attach checkout listeners (delegation would be ideal; small list so direct is fine)
      refs.attendanceLog.querySelectorAll('.checkout-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const docId = e.currentTarget.dataset.id;
          await handleCheckout(docId);
        });
      });
    }

    async function handleCheckout(docId) {
      if (!docId) { alert('Error: No attendance record found.'); return; }
      try {
        ui.showLoading('Checking out...');
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', hour12:true });
        await updateDoc(doc(db, 'attendance_test', docId), { checkout: timeString, lastUpdated: now });
        alert('✅ Checked out successfully!');
      } catch (err) {
        console.error('Checkout error', err);
        alert('❌ Failed to check out. Please try again.');
      } finally {
        ui.hideLoading();
      }
    }

    /* ---------------------------
       LEAVE SUBMISSION
       --------------------------- */
    async function submitLeaveRequest(evt) {
      evt.preventDefault();
      if (!currentUid || !currentUserData) { alert('User not authenticated. Please log in again.'); return; }
      const leaveType = refs.leaveForm.leaveType.value || refs.leaveForm.querySelector('#leaveType').value;
      const startDate = refs.startDate.value;
      const endDate = refs.endDate.value;
      const reason = refs.reason.value || '';
      if (!leaveType || !startDate || !endDate) { alert('Please fill in all required fields.'); return; }
      if (new Date(startDate) > new Date(endDate)) { alert('End date must be after start date.'); return; }
      try {
        ui.showLoading('Submitting leave request...');
        await addDoc(collection(db, 'leaveRequests'), {
          userId: currentUid,
          userName: `${currentUserData.firstName || ''} ${currentUserData.lastName || ''}`.trim() || 'User',
          leaveType, startDate, endDate, reason, status: 'pending', createdAt: new Date()
        });
        alert('Leave request submitted successfully!');
        refs.applyLeaveModal.style.display = 'none';
        refs.leaveForm.reset();
      } catch (err) {
        console.error('submitLeaveRequest', err);
        alert('Failed to submit leave request. Please try again.');
      } finally {
        ui.hideLoading();
      }
    }

    /* ---------------------------
       HELPERS: date formatting
       --------------------------- */
    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      try { return new Date(dateStr).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' }); }
      catch (_) { return dateStr; }
    }

    /* ---------------------------
       UI EVENTS (init)
       --------------------------- */
    function initUI() {
      // date constraints
      const today = new Date().toISOString().split('T')[0];
      refs.startDate.min = today; refs.endDate.min = today;

      // modal open/close
      refs.applyLeaveBtn.addEventListener('click', () => { refs.applyLeaveModal.style.display = 'flex'; refs.applyLeaveModal.setAttribute('aria-hidden','false'); });
      refs.closeModal.addEventListener('click', () => { refs.applyLeaveModal.style.display = 'none'; refs.applyLeaveModal.setAttribute('aria-hidden','true'); });
      refs.cancelLeave.addEventListener('click', () => { refs.applyLeaveModal.style.display = 'none'; refs.applyLeaveModal.setAttribute('aria-hidden','true'); });
      window.addEventListener('click', e => { if (e.target === refs.applyLeaveModal) { refs.applyLeaveModal.style.display = 'none'; refs.applyLeaveModal.setAttribute('aria-hidden','true'); }});

      // toggle sidebar
      refs.toggleSidebar.addEventListener('click', () => {
        refs.sidebar.classList.toggle('collapsed');
        const icon = refs.toggleSidebar.querySelector('i');
        icon.className = refs.sidebar.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
      });

      // form submit
      refs.leaveForm.addEventListener('submit', submitLeaveRequest);

      // accessibility: close modal with escape
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { refs.applyLeaveModal.style.display = 'none'; refs.applyLeaveModal.setAttribute('aria-hidden','true'); }});
    }

    /* ---------------------------
       AUTH LISTENER
       --------------------------- */
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUid = user.uid;
        ui.showLoading('Loading user data...');
        try {
          const userDoc = await getDoc(doc(db, 'users', currentUid));
          if (userDoc.exists()) {
            currentUserData = userDoc.data();
            updateSidebarUI(currentUserData);
            buildNavigation(currentUserData.role || 'staff');
          } else {
            console.warn('User doc not found');
            buildNavigation('staff');
          }

          // setup listeners
          setupLeaveListenersRealtime();
          setupAttendanceListenerRealtime();
          await loadWarningLettersOnce();
        } catch (err) {
          console.error('Auth init error', err);
        } finally {
          ui.hideLoading();
        }
      } else {
        ui.hideLoading();
        window.location.href = '/';
      }
    });

    function updateSidebarUI(userData = {}) {
      const firstName = userData.firstName || '';
      const lastName = userData.lastName || '';
      const email = userData.email || '';
      const initials = ((firstName.charAt(0) || '') + (lastName.charAt(0) || '')).toUpperCase() || 'U';
      refs.sidebarUserName.textContent = firstName || 'User';
      refs.sidebarUserEmail.textContent = email || 'No email';
      refs.sidebarAvatar.textContent = initials;
      refs.welcomeText.textContent = `Welcome, ${firstName || 'User'}!`;
    }

    /* ---------------------------
       BOOT
       --------------------------- */
    (function boot() {
      initUI();
      ui.showLoading();
      // small timeout so user sees loading while firebase initializes
      setTimeout(() => ui.hideLoading(), 600);
    })();

    /* ---------------------------
       Expose small helpers for debugging (optional)
       --------------------------- */
    window._app = { ui, db, auth };
  </script>
</body>
</html>
